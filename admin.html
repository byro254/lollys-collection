<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Lolly's Collection</title>
     <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/x-icon" href="images/icons/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* --- Dark Pink & White Color Theme --- */
        :root { 
            --color-bg-light: #FFFFFF;
            --color-bg-page: #F4F4F9;
            --color-pink-dark: #C2185B;
            --color-pink-accent: #E91E63;
            --color-text-dark: #333333;
            --color-text-light: #F4F4F9;
            --color-text-subtle: #757575;
            --color-border-light: #F0F0F0;
            --color-border-medium: #E0E0E0;
            --color-shadow: rgba(0,0,0,0.08);

            /* Status Colors */
            --color-warning: #ffc107; /* Pending/Low Stock */
            --color-success: #28a745; /* In Stock/Shipped/Completed/Active */
            --color-danger: #dc3545; /* Out of Stock/Delete/Deactivated */
            --color-info: #17a2b8; /* Contacted */
            --color-primary: var(--color-pink-accent);

            /* Typography */
            --font-heading: 'Playfair Display', serif;
            --font-body: 'Poppins', sans-serif;
        }

        /* --- Global Styles & Layout (Existing styles omitted for brevity, ensure all are included) --- */
        body {
            font-family: var(--font-body);
            background-color: var(--color-bg-page);
            color: var(--color-text-dark);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
        }
        h1, h2 {
            font-family: var(--font-heading);
            color: var(--color-pink-dark);
        }
        h2 {
            font-size: 2.2rem;
            margin-bottom: 30px;
        }
        h3 {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            color: var(--color-text-dark);
            margin-top: 0;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--color-border-medium);
        }
        
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: var(--color-text-light);
            font-weight: 500;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0; /* Starts hidden */
            transform: translateX(100%);
            max-width: 300px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success { background-color: var(--color-success); }
        .toast.error { background-color: var(--color-danger); }
        .toast.info { background-color: var(--color-info); }
        /* --- Sidebar Navigation --- */
        .sidebar {
            width: 250px;
            background-color: var(--color-pink-dark);
            color: var(--color-text-light);
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            position: fixed;
            height: 100%;
            overflow-y: auto;
            transition: width 0.3s;
        }
        .sidebar-header {
            text-align: center;
            color: var(--color-text-light);
            margin-bottom: 30px;
            font-weight: 700;
            font-size: 1.5rem;
            font-family: var(--font-heading);
        }
        .sidebar-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-nav li a {
            display: block;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--color-text-light);
            transition: background-color 0.3s, color 0.3s;
            font-size: 1rem;
            font-weight: 500;
        }
        .sidebar-nav li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .sidebar-nav li a:hover,
        .sidebar-nav li a.active {
            background-color: var(--color-pink-accent);
            color: var(--color-bg-light);
        }
        
        /* --- Main Content Area & Cards --- */
        .main-content {
            margin-left: 250px;
            padding: 30px;
            flex-grow: 1;
            width: calc(100% - 250px);
        }
        .content-section {
            display: none;
            animation: fadeIn 0.5s;
        }
        .content-section.active {
            display: block;
        }
        .card {
            background-color: var(--color-bg-light);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--color-shadow);
            margin-bottom: 30px;
        }
        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Dashboard Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            padding: 20px;
            background-color: var(--color-bg-light);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--color-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 5px solid var(--color-pink-accent);
        }
        .stat-card-info {
            flex-grow: 1;
        }
        .stat-card-info p {
            margin: 0;
            font-size: 1rem;
            color: var(--color-text-subtle);
        }
        .stat-card-info h4 {
            margin: 5px 0 0;
            font-size: 2rem;
            font-family: var(--font-heading);
            color: var(--color-pink-dark);
        }
        .stat-card i {
            font-size: 2.5rem;
            color: var(--color-pink-accent);
            opacity: 0.7;
        }
        
        /* --- Input and Buttons --- */
        input[type="text"], 
        input[type="number"], 
        input[type="email"], 
        textarea, 
        select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--color-border-medium);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
            font-family: var(--font-body);
        }
        /* Specific styling for file input to make it look nicer */
        input[type="file"] {
            padding: 10px;
            background-color: var(--color-bg-page);
            border: 1px dashed var(--color-pink-accent);
            cursor: pointer;
        }

        .submit-button, .action-button, .action-btn {
            background-color: var(--color-pink-accent);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .submit-button:hover, .action-button:hover, .action-btn:hover {
            background-color: var(--color-pink-dark);
            transform: translateY(-1px);
        }
        
        /* Form Row Grouping for Responsiveness */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .form-row > div {
            flex: 1;
        }
        .form-row label {
             margin-bottom: 5px; 
             display: block;
             font-weight: 500;
        }
        .form-row input, .form-row select {
            margin-bottom: 0; 
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            .form-row input, .form-row select {
                margin-bottom: 15px; /* Restore margin on small screens for vertical stacking */
            }
        }
        
        /* Table Styling */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--color-border-light);
            font-size: 0.95rem;
        }
        .data-table th {
            background-color: var(--color-bg-page);
            color: var(--color-pink-dark);
            font-weight: 600;
            text-transform: uppercase;
        }
        .data-table tbody tr:hover {
             background-color: #fcfcfc;
             cursor: pointer;
        }
        .data-table .no-hover:hover {
             background-color: transparent;
             cursor: default;
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-bg-light);
            text-align: center;
        }
        .status-badge.pending { background-color: var(--color-warning); color: var(--color-text-dark); }
        .status-badge.completed, .status-badge.delivered, .status-badge.active { 
            background-color: var(--color-success); 
            color: var(--color-bg-light); 
        }
        .status-badge.shipped { background-color: var(--color-info); }
        .status-badge.deactivated { 
            background-color: var(--color-danger); 
            color: var(--color-bg-light); 
        }
        /* New Badges for Finance */
        .status-badge.deposit { background-color: var(--color-success); }
        .status-badge.deduction, .status-badge.expenditure { background-color: var(--color-danger); }


        /* Table Action Buttons & Modal */
        .table-action-btn {
            background: none;
            border: none;
            color: var(--color-pink-dark);
            cursor: pointer;
            margin-left: 5px;
            font-size: 1rem;
            transition: color 0.2s;
            padding: 5px;
            line-height: 1;
        }
        .table-action-btn:hover {
            color: var(--color-pink-accent);
        }
        .btn-complete { background-color: var(--color-success); color: white; padding: 6px 10px; font-size: 0.9rem; }
        .btn-complete:hover { background-color: #1e7e34; }
        .btn-view { color: var(--color-info); }
        
        /* NEW: Customer Status Toggle Button */
        .btn-toggle-status { 
            padding: 6px 10px; 
            font-size: 0.85rem; 
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-toggle-status.deactivate { 
            background-color: var(--color-danger); 
            color: white; 
        }
        .btn-toggle-status.activate { 
            background-color: var(--color-success); 
            color: white; 
        }

        
        /* --- Message Section Styles --- */
        .messages-grid {
            display: grid;
            /* Responsive grid: min 300px wide cards */
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px;
            margin-top: 30px;
        }

        .message-card {
            background-color: var(--color-bg-light); /* Assuming white background */
            border: 1px solid #e0e0e0;
            border-left: 5px solid var(--color-pink-accent); /* Pink accent border */
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 10px var(--color-shadow);
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* To push button to bottom */
        }

        .message-header {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .message-header h4 {
            margin: 0;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--color-pink-dark);
        }

        .message-header p {
            margin: 5px 0 0;
            font-size: 0.85rem;
            color: var(--color-text-subtle);
            overflow-wrap: break-word;
        }

        .message-body {
            flex-grow: 1; 
            font-size: 0.9rem;
            color: var(--color-text-dark);
            line-height: 1.5;
            margin-bottom: 15px;
            background-color: #fcfcfc;
            padding: 10px;
            border-radius: 4px;
            /* Limit height to prevent huge cards for long messages */
            max-height: 200px; 
            overflow-y: auto; 
        }

        .message-footer {
            text-align: right;
            font-size: 0.75rem;
            color: var(--color-text-subtle);
            margin-bottom: 10px; /* Space above the button */
        }
        
        .message-actions {
            text-align: right;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }
        /* Modal Styling (Order Details) */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
            /* Added for Auth Gate modal to center vertically as well */
            align-items: center; 
            justify-content: center; 
        }
        .modal-content {
            background-color: var(--color-bg-light);
            margin: 5% auto; 
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
            position: relative;
        }
        /* Style for the new reply modal content */
        #reply-modal .modal-content {
             max-width: 550px;
        }
        /* Style for the new withdrawal modal content */
        #withdrawal-modal .modal-content {
             max-width: 450px;
        }
        .close-btn {
            color: var(--color-text-dark);
            float: right;
            font-size: 30px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted var(--color-border-medium);
        }
        .detail-item:last-of-type { border-bottom: none; }
        #modal-items-list {
            list-style: none;
            padding: 0;
        }
        #modal-items-list li {
            padding: 10px 0;
            border-bottom: 1px solid var(--color-border-light);
            display: flex;
            flex-direction: column; /* Allow content to stack */
            font-size: 0.95rem;
        }
        #modal-items-list li .item-line {
            display: flex;
            justify-content: space-between;
        }
        #modal-items-list li .item-meta {
            font-size: 0.85rem;
            color: var(--color-text-subtle);
            margin-top: 3px;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* --- NEW: Chat Specific Styles --- */
        #chat-sessions-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .chat-session-item {
            padding: 15px;
            border-bottom: 1px solid var(--color-border-medium);
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-session-item:hover {
            background-color: var(--color-bg-page);
        }
        .chat-session-item:last-child {
            border-bottom: none;
        }
        .chat-session-item strong {
            color: var(--color-pink-dark);
            font-weight: 600;
        }
        .chat-session-item span {
            font-size: 0.85rem;
            color: var(--color-text-subtle);
        }

        #chat-modal .modal-content {
            max-width: 450px;
            margin-top: 10vh;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid var(--color-border-medium);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            height: 400px; /* Fixed height for chat window */
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .chat-message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .chat-message.admin {
            align-self: flex-end;
            background-color: var(--color-pink-accent);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-message.customer {
            align-self: flex-start;
            background-color: var(--color-bg-page);
            color: var(--color-text-dark);
            border: 1px solid var(--color-border-medium);
            border-bottom-left-radius: 4px;
        }
        .chat-message.system { /* New style for system messages */
            align-self: center;
            background-color: #f0f0f0;
            color: var(--color-text-subtle);
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 4px;
            text-align: center;
        }
        #chat-input-form {
            display: flex;
            gap: 10px;
        }
        #chat-input {
            flex-grow: 1;
            margin-bottom: 0;
        }
        #chat-send-btn {
            padding: 10px;
            width: 100px;
        }
        

        .scrollable-table-container {
            max-height: 500px; 
            overflow-y: auto; 
            border: 1px solid var(--color-border-medium); 
            border-radius: 8px;
        }


        .scrollable-table-container table {
          width: 100%;
          margin: 0;
          border: none; 
        }

        .scrollable-table-container th {
           position: sticky;
           top: 0;
           z-index: 2; 
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">Lolly's Admin</div>
       <nav class="sidebar-nav">
    <ul>
        <li><a href="#dashboard" class="nav-link" data-target="dashboard"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
        <li><a href="#orders" class="nav-link active" data-target="orders"><i class="fas fa-shopping-cart"></i> <span>Orders</span></a></li>
        <!-- ðŸš¨ NEW MONEY TRACKER LINK -->
        <li><a href="#finance" class="nav-link" data-target="finance"><i class="fas fa-money-bill-wave"></i> <span>Finance</span></a></li>
        <!-- END NEW LINK -->
        <li><a href="#products" class="nav-link" data-target="products"><i class="fas fa-boxes"></i> <span>Products</span></a></li>
        <li><a href="#customers" class="nav-link" data-target="customers"><i class="fas fa-users"></i> <span>Customers</span></a></li>
        <li><a href="#messages" class="nav-link" data-target="messages"><i class="fas fa-envelope"></i> <span>Messages</span></a></li>
        <li><a href="#chat" class="nav-link" data-target="chat">
            <i class="fas fa-comments"></i> 
            <span>Client Support</span>
            <span id="chat-notification-icon" style="display: none; background-color: var(--color-danger); color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; margin-left: 5px; line-height: 1;">!</span>
        </a></li>
        <li><a href="#" class="nav-link" id="logout-link" style="margin-top: 50px;"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
    </ul>
</nav>
    </aside>

    <main class="main-content">
        
        <section id="dashboard" class="content-section">
            <h2>
                <i class="fas fa-chart-line"></i> Dashboard Overview
                <!-- ðŸš¨ FIX 1: Agent Name Display -->
                <small id="agent-welcome-message" style="font-size: 0.8em; font-family: var(--font-body); font-weight: 400; color: var(--color-text-subtle); display: block; margin-top: 5px;">
                    Welcome, Agent!
                </small>
            </h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-info">
                        <p>Total Customers</p>
                        <h4 id="stat-customers">...</h4>
                    </div>
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-card-info">
                        <p>Pending Orders</p>
                        <h4 id="stat-pending-orders">...</h4>
                    </div>
                    <i class="fas fa-hourglass-half" style="color: var(--color-warning);"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-card-info">
                        <p>Completed Orders</p>
                        <h4 id="stat-completed-orders">...</h4>
                    </div>
                    <i class="fas fa-check-circle" style="color: var(--color-success);"></i>
                </div>
            </div>

            <div class="card">
                <h3>Monthly Sales Trend</h3>
                <div style="height: 300px;">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
            
        </section>

        <section id="orders" class="content-section active">
            <h2>
                <i class="fas fa-receipt"></i> Order Management
            </h2>
            
            <div class="card" style="margin-bottom: 40px;">
                <div class="flex-between">
                    <h3>Pending Orders</h3>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Customer</th>
                                <th>Location</th>
                                <th>Total</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pending-orders-tbody">
                            <tr><td colspan="7" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Loading pending orders...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>Completed Orders</h3>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Customer</th>
                                <th>Location</th>
                                <th>Total</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="completed-orders-tbody">
                            <tr><td colspan="7" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Loading completed orders...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- ðŸš¨ NEW FINANCE SECTION -->
        <section id="finance" class="content-section">
            <h2>
                <i class="fas fa-money-bill-wave"></i> Finance
            </h2>
            
            <div class="stats-grid">
                <!-- Card 1: Total Balance -->
                <div class="stat-card" style="border-left: 5px solid var(--color-success);">
                    <div class="stat-card-info">
                        <p>Current Account Balance</p>
                        <h4 id="finance-total-balance">KES 0.00</h4>
                    </div>
                    <i class="fas fa-wallet" style="color: var(--color-success); opacity: 0.7;"></i>
                </div>
                
                <!-- Card 2: Money In -->
                <div class="stat-card" style="border-left: 5px solid var(--color-info);">
                    <div class="stat-card-info">
                        <p>Total Money In (Orders/Deposits)</p>
                        <h4 id="finance-money-in">KES 0.00</h4>
                    </div>
                    <i class="fas fa-arrow-alt-circle-up" style="color: var(--color-info); opacity: 0.7;"></i>
                </div>
                
                <!-- Card 3: Money Out -->
                <div class="stat-card" style="border-left: 5px solid var(--color-danger);">
                    <div class="stat-card-info">
                        <p>Total Money Out (Restock/Refunds)</p>
                        <h4 id="finance-money-out">KES 0.00</h4>
                    </div>
                    <i class="fas fa-arrow-alt-circle-down" style="color: var(--color-danger); opacity: 0.7;"></i>
                </div>
            </div>
            
            <div class="card">
                <div class="flex-between">
                    <h3><i class="fas fa-history"></i> Detailed Transaction History</h3>
                    <button class="submit-button" onclick="openWithdrawalModal()">
                        <i class="fas fa-credit-card"></i> Withdraw / Log Expenditure
                    </button>
                </div>
                
                <div class="scrollable-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount (KES)</th>
                                <th>Order ID / Ref</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="finance-transactions-tbody">
                            <tr><td colspan="5" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Loading financial data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        <!-- END NEW FINANCE SECTION -->


        <section id="products" class="content-section">
            <h2><i class="fas fa-boxes"></i> Product Management</h2>
            
            <div class="card">
                <h3><i class="fas fa-plus-circle"></i> Upload New Product</h3>
                <form id="product-upload-form">
                    
                    <label for="product-name">Product Name:</label>
                    <input type="text" id="product-name" name="name" required>

                    <div class="form-row">
                        <div>
                            <label for="product-price">Price (KES):</label>
                            <input type="number" id="product-price" name="price" step="0.01" min="0.01" required>
                        </div>
                        <div>
                            <label for="product-category">Category:</label>
                            <select id="product-category" name="category" required>
                                <option value="" disabled selected>Select a Category</option>
                               <option value="Cap">Cap</option>
                               <option value="Topwear">Topwear</option>
                               <option value="Bottomwear">Bottomwear</option>
                               <option value="Footwear">Footwear</option>
                               <option value="Dresses">Dresses</option>
                               <option value="Apparel">Apparel</option>
                               <option value="Electronics">Electronics</option>
                               <option value="HomeDecor">Home Decor</option>
                               <option value="Phone Accessories">Phone Accessories</option>
                            </select>
                        </div>
                    </div>
                    <div id="toast-container">
                    </div> 
                    <div class="form-row">
                        <div>
                            <label for="product-image-file">Product Image (File Upload):</label>
                           <input type="file" name="productImage" id="image-upload" accept="image/*" required>
                        </div>
                        <div>
                            <label for="product-guaranty">Warranty/Guaranty (Months):</label>
                            <input type="number" id="product-guaranty" name="guaranty" min="0" value="0" required>
                        </div>
                    <div class="form-group">
                  <label for="product-stock">Stock Quantity</label>
                   <input type="number" id="product-stock" name="stock" min="0" value="1" required>
                  </div>
                    </div>

                    <label for="product-description">Description:</label>
                    <textarea id="product-description" name="description" rows="4" required></textarea>
                    
                    <button type="submit" class="submit-button" id="upload-btn"><i class="fas fa-upload"></i> Upload Product</button>
                    <p id="upload-status" style="margin-top: 15px; font-weight: 600;"></p>
                </form>
            </div>
           
            <div class="card">
    <h3><i class="fas fa-list"></i> Current Products List</h3>
    <div id="edit-product-form-container" class="card" style="display: none;">
    <h3><i class="fas fa-edit"></i> Edit Product Details</h3>
    <form id="edit-product-form">
        <input type="hidden" id="edit-product-id" name="id"> 
        <input type="hidden" id="edit-existing-image-url" name="existing_image_url"> 

        <div class="form-group-grid">
            <div class="form-group">
                <label for="edit-name">Name</label>
                <input type="text" id="edit-name" name="name" required>
            </div>
            
            <div class="form-group">
                <label for="edit-price">Price</label>
                <input type="number" id="edit-price" name="price" step="0.01" required>
            </div>

            <div class="form-group">
                <label for="edit-category">Category</label>
                <input type="text" id="edit-category" name="category">
            </div>

            <div class="form-group">
                <label for="edit-stock">Stock Quantity</label>
                <input type="number" id="edit-stock" name="stock" min="0" required>
            </div>
        </div>

        <div class="form-group">
            <label for="edit-description">Description</label>
            <textarea id="edit-description" name="description"></textarea>
        </div>

        <div class="form-group">
            <label for="edit-product-image">Change Image (Optional)</label>
            <input type="file" id="edit-product-image" name="productImage" accept="image/*">
            <p>Current Image:</p>
            <img id="current-edit-image" src="" alt="Current Product Image" style="max-width: 100px; max-height: 100px; display: block; margin-top: 10px;">
        </div>

        <button type="submit" id="update-btn" class="btn btn-primary">Save Changes</button>
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('edit-product-form-container').style.display='none'">Cancel</button>
    </form>
</div>
    <div id="product-list-container">
        <p id="loading-message">Loading existing products...</p> 

        <div class="scrollable-table-container"> 
            <table class="product-table data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Stock</th>
                        <th>Image</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="products-table-body"> 
                </tbody>
            </table>
        </div>
    </div>
</div>
        </section>
        
        <section id="messages" class="content-section">
            <h2><i class="fas fa-envelope-open-text"></i> Customer Contact Messages</h2>
            <div class="card">
                <div class="flex-between">
                    <h3>All Submissions</h3>
                </div>
                <div id="messages-list" class="messages-grid">
                    <p id="messages-loading">Loading messages...</p>
                    </div>
            </div>
        </section>
        
        <section id="chat" class="content-section">
            <h2><i class="fas fa-comments"></i> Client Support (Live Chat)</h2>
            <div class="card">
                <h3>Active & Recent Chat Sessions</h3>
                <div id="chat-list-container" class="table-responsive">
                    <p id="chat-loading" style="text-align: center; color: var(--color-text-subtle);">Loading user list...</p>
                    <ul id="chat-sessions-list">
                        </ul>
                </div>
            </div>
           
        </section>
        <section id="customers" class="content-section">
            <h2><i class="fas fa-users"></i> Customer Management</h2>
            <div class="card">
                <div class="flex-between">
                    <h3>All Registered Customers</h3>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Date Registered</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customers-tbody">
                            <tr><td colspan="6" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Loading customer data...</td></tr>
                        </tbody>
                    </table>
                </div>
               
            </div>
        </section>
        
        <section id="settings" class="content-section">
            <h2><i class="fas fa-cog"></i> Application Settings</h2>
            <div class="card">
                <h3>General Configurations</h3>
                <p>This section is for site-wide settings like shipping fees, VAT rates, and payment gateway configuration.</p>
                <form>
                    <label for="shipping-fee">Default Shipping Fee KES:</label>
                    <input type="number" id="shipping-fee" value="300" step="0.01">
                    <label for="admin-email">Admin Contact Email:</label>
                    <input type="email" id="admin-email" value="support@lollyscollection.com">
                    <button type="submit" class="submit-button">Save Settings</button>
                </form>
            </div>
        </section>
         
        <footer style="text-align: center; color: var(--color-text-subtle); font-size: 0.85rem; padding-top: 20px;">
            &copy; 2025 Lolly's Collection Admin Pane | Developed by Byron Oyoo
        </footer>
    </main>
    
    <div id="order-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="modal-order-title">Order #<span id="modal-order-id"></span></h3>
            
            <div id="order-details-info">
                <div class="detail-item"><span>Customer Name:</span> <strong id="modal-customer-name"></strong></div>
                <div class="detail-item"><span>Contact Email:</span> <strong id="modal-customer-email"></strong></div>
                <div class="detail-item"><span>Delivery Location:</span> <strong id="modal-delivery-location"></strong></div>
                <div class="detail-item"><span>Order Date:</span> <strong id="modal-order-date"></strong></div>
            </div>

            <h3 style="margin-top: 25px;">Order Items</h3>
            <ul id="modal-items-list">
                </ul>

            <div class="detail-item" style="font-size: 1.2rem; margin-top: 20px; border-top: 2px solid var(--color-pink-accent);">
                <span>Grand Total:</span> <strong id="modal-total-amount"></strong>
            </div>
            
            <p id="modal-loading-message" style="text-align: center; color: var(--color-text-subtle); margin-top: 15px; display: none;"></p>
        </div>
    </div>
    
    <div id="reply-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('reply-modal').style.display='none'">&times;</span>
            <h3><i class="fas fa-reply"></i> Send Response to Customer</h3>
            
            <form id="reply-form">
                <label for="reply-email-to">Customer Email (To):</label>
                <input type="email" id="reply-email-to" name="emailTo" required readonly style="background-color: var(--color-bg-page);">
                
                <div class="form-row">
                    <div>
                        <label for="reply-email-from">Admin Email (From):</label>
                        <input type="email" id="reply-email-from" name="emailFrom" value="support@lollyscollection.com" required>
                    </div>
                    <div>
                        <label for="reply-date">Date Sent:</label>
                        <input type="text" id="reply-date" name="dateSent" required readonly>
                    </div>
                </div>

                <label for="reply-subject">Subject:</label>
                <input type="text" id="reply-subject" name="subject" value="Re: Your Inquiry at Lolly's Collection" required>
                
                <label for="reply-content">Reply Content:</label>
                <textarea id="reply-content" name="content" rows="6" required placeholder="Type your response here..."></textarea>
                
                <button type="submit" class="submit-button" id="send-reply-btn"><i class="fas fa-paper-plane"></i> Send Reply</button>
            </form>
        </div>
    </div>
    <div id="delete-confirm-modal" class="modal" style="display: none;">
    <div class="modal-content small-modal">
        <span class="close-button" onclick="document.getElementById('delete-confirm-modal').style.display='none'">&times;</span>
        <h2 style="color: var(--color-danger);"><i class="fas fa-exclamation-triangle"></i> Confirm Deletion</h2>
        
        <p id="delete-message">Are you sure you want to permanently delete this product? This action cannot be undone.</p>
        
        <p style="margin-top: 15px; font-weight: bold;">Product: <span id="product-to-delete-name"></span></p>

        <div class="modal-actions" style="margin-top: 20px;">
            <button id="confirm-delete-btn" class="btn btn-danger" data-product-id="">Yes, Delete It</button>
            <button class="btn btn-secondary" onclick="document.getElementById('delete-confirm-modal').style.display='none'">Cancel</button>
        </div>
    </div>
</div>
    
    <div id="auth-gate-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 450px; text-align: center; padding: 40px;">
            <i class="fas fa-lock" style="font-size: 3rem; color: var(--color-pink-accent); margin-bottom: 20px;"></i>
            <h3 style="border-bottom: none; margin-bottom: 15px;">Admin Access Required</h3>
            <p>You must be logged in as an administrator to access the Lolly's Collection Dashboard.</p>
            <button class="submit-button" onclick="redirectToAuthPage()" style="margin-top: 20px;">
                <i class="fas fa-sign-in-alt"></i> Login Now
            </button>
        </div>
    </div>
    
    <!-- ðŸš¨ NEW WITHDRAWAL MODAL -->
    <div id="withdrawal-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('withdrawal-modal').style.display='none'">&times;</span>
            <h3><i class="fas fa-hand-holding-usd"></i> Log Business Expenditure</h3>
            
            <form id="withdrawal-form">
                
                <label for="withdraw-amount">Amount to Withdraw (KES):</label>
                <input type="number" id="withdraw-amount" name="amount" step="0.01" min="1" required>

                <label for="withdraw-purpose-select">Purpose Category:</label>
                <select id="withdraw-purpose-select" name="purposeCategory" required>
                    <option value="" disabled selected>Select reason for expenditure</option>
                    <option value="Restock/Inventory Purchase">Restock / Inventory Purchase</option>
                    <option value="Refund (Customer)">Refund (Customer)</option>
                    <option value="Loan Payment">Loan Payment</option>
                    <option value="Marketing/Advertising">Marketing / Advertising</option>
                    <option value="Other Business Expense">Other Business Expense</option>
                </select>

                <label for="withdraw-purpose-details">Details / Reference:</label>
                <textarea id="withdraw-purpose-details" name="purposeDetails" rows="2" required placeholder="e.g., Supplier name, Loan ID, Customer email for refund..."></textarea>
                
                <button type="submit" class="submit-button" id="withdraw-btn"><i class="fas fa-sign-out-alt"></i> Confirm Withdrawal</button>
            </form>
        </div>
    </div>
    <!-- END NEW WITHDRAWAL MODAL -->

    <div id="chat-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeChatModal()">&times;</span>
            <h3 id="chat-modal-title" style="border-bottom: none;">Live Chat with Customer <span id="chat-customer-name">...</span></h3>
            
            <div id="chat-messages">
                </div>
            
            <form id="chat-input-form">
                <input type="text" id="chat-input" placeholder="Type your message..." required>
                <button type="submit" class="submit-button" id="chat-send-btn"><i class="fas fa-paper-plane"></i> Send</button>
            </form>
        </div>
    </div>
  <div id="handoff-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 450px; text-align: center; padding: 40px;">
            <i class="fas fa-handshake" style="font-size: 3rem; color: var(--color-warning); margin-bottom: 20px;"></i>
            <h3 style="border-bottom: none; margin-bottom: 15px;">Live Chat Handoff Request!</h3>
            <p>Customer <strong id="handoff-customer-name"></strong> is requesting a live agent.</p>
            <p style="font-size: 0.9rem; color: var(--color-text-subtle);">Last Message: "<span id="handoff-customer-message">...</span>"</p>
            <button class="submit-button" id="handoff-accept-btn" style="margin-top: 20px;">
                <i class="fas fa-comments"></i> Accept Chat
            </button>
             <!-- ðŸš¨ FIX 2: Rename 'Dismiss' button to 'Ignore' -->
             <button class="action-button" id="handoff-reject-btn" style="background-color: var(--color-danger); margin-left: 10px;">
                <i class="fas fa-eye-slash"></i> Ignore
            </button>
        </div>
    </div>
  <script>
       // Ensure this URL matches your backend API
const API_BASE_URL = '/api'; 
// ðŸš¨ NEW: Admin Wallet API
const ADMIN_FINANCE_HISTORY_URL = `${API_BASE_URL}/admin/finance/history`;
const ADMIN_EXPENDITURE_URL = `${API_BASE_URL}/admin/finance/expenditure`;

// Chart instance reference
let salesChartInstance = null;
let allProducts = [];
let deleteProductIdToConfirm = null;
let adminNotificationSocket = null; // New persistent socket for notifications
let unreadSessions = new Set(); // Stores customerId's with unread messages
// Global variables for auto-refresh timers
let dashboardIntervalId = null;
let ordersIntervalId = null;
const REFRESH_INTERVAL_MS = 1800000; // 30 minutes

// --- NEW CHAT GLOBALS ---
let webSocket = null;
let currentChatCustomerId = null;
let agentName = 'Agent'; // Default agent name
// --- END NEW CHAT GLOBALS ---

// --- Authentication Gate Logic (NEW) ---

/**
 * Redirects the user to the dedicated authentication page.
 */
function redirectToAuthPage() {
    // In a real application, this would redirect to your login page
    // For this environment, we'll simulate the redirect
    console.log('Redirecting to /auth.html for login.');
     window.location.href = '/auth.html'; 
}

/**
 * Checks the authentication status of the user via API and retrieves the agent's name.
 */
async function checkAdminAuthentication() {
    try {
        // Assume /api/auth/check also returns user details if authenticated
        const response = await fetch(`${API_BASE_URL}/auth/check`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
        });

        if (response.ok) {
            const result = await response.json();
            
            // ðŸš¨ FIX 3: Capture the agent's full name from the session response
            // We rely on the server.js returning fullName or name in the check response
            agentName = result.full_name || result.name || 'Admin';
            
            // Update the dashboard greeting immediately
            document.getElementById('agent-welcome-message').textContent = `Welcome, ${agentName}!`;

            document.getElementById('auth-gate-modal').style.display = 'none';
            document.body.style.overflow = 'auto'; // Re-enable scrolling
            
            document.querySelector('.main-content').style.pointerEvents = 'auto';
            document.querySelector('.sidebar-nav').style.pointerEvents = 'auto';
            
            return true;
        } else {
            const result = await response.json().catch(() => ({ message: 'Unauthenticated' }));
            console.warn('Authentication required:', result.message || 'Not logged in.');
            displayAuthGate();
            return false;
        }

    } catch (error) {
        console.error('Network error during auth check:', error);
        displayAuthGate();
        return false;
    }
}

/**
 * Displays the modal and disables page interaction.
 */
function displayAuthGate() {
    const authModal = document.getElementById('auth-gate-modal');
    authModal.style.display = 'flex'; // Use flex to better center content vertically
    document.body.style.overflow = 'hidden'; // Prevent scrolling the main page
    
    // Disable interaction with the main content area by preventing clicks
    document.querySelector('.main-content').style.pointerEvents = 'none';
    document.querySelector('.sidebar-nav').style.pointerEvents = 'none';
    
    // Ensure the modal is always on top
    authModal.style.zIndex = '10000'; 
}


// --- Auto Refresh Functions ---

async function autoRefreshDashboard() {
    // Check auth status before running refresh
    if (!(await checkAdminAuthentication())) return; 
    // console.log('Auto-refreshing Dashboard...');
    await fetchDashboardStats();
    await fetchAndRenderSalesChart();
}

async function autoRefreshOrders() {
    // Check auth status before running refresh
    if (!(await checkAdminAuthentication())) return; 
    // console.log('Auto-refreshing Orders...');
    await fetchAndRenderOrders();
}

// ðŸš¨ NEW: Auto Refresh Finance Data
async function autoRefreshFinance() {
    if (!(await checkAdminAuthentication())) return;
    // console.log('Auto-refreshing Finance...');
    await fetchFinancialData();
}


/**
 * Manages the automatic refresh for a given section.
 * @param {string | null} sectionId - The ID of the section to manage ('dashboard', 'orders', or 'finance').
 */
function manageAutoRefresh(sectionId) {
    // 1. Clear all existing intervals to prevent overlap
    if (dashboardIntervalId) {
        clearInterval(dashboardIntervalId);
        dashboardIntervalId = null;
    }
    if (ordersIntervalId) {
        clearInterval(ordersIntervalId);
        ordersIntervalId = null;
    }
    // ðŸš¨ NEW: Clear finance interval
    if (window.financeIntervalId) {
        clearInterval(window.financeIntervalId);
        window.financeIntervalId = null;
    }


    // 2. Start the interval for the currently active section
    if (sectionId === 'dashboard') {
        autoRefreshDashboard(); 
        dashboardIntervalId = setInterval(autoRefreshDashboard, REFRESH_INTERVAL_MS);
    } else if (sectionId === 'orders') {
        autoRefreshOrders();
        ordersIntervalId = setInterval(autoRefreshOrders, REFRESH_INTERVAL_MS);
    } else if (sectionId === 'finance') {
        // ðŸš¨ NEW: Start finance interval
        autoRefreshFinance();
        window.financeIntervalId = setInterval(autoRefreshFinance, REFRESH_INTERVAL_MS);
    }
}


// --- Utility Functions ---

/**
 * Fetches dashboard statistics (customers, pending/completed orders).
 */
async function fetchDashboardStats() {
    try {
        const response = await fetch(`${API_BASE_URL}/dashboard/stats`);
        const stats = await response.json(); 

        if (!response.ok) throw new Error(stats.message || 'Failed to fetch dashboard stats.');

        // FIX APPLIED: Using stats.userCount to match the server-side code.
        document.getElementById('stat-customers').textContent = stats.userCount || 0;
        document.getElementById('stat-pending-orders').textContent = stats.pendingOrders || 0;
        document.getElementById('stat-completed-orders').textContent = stats.completedOrders || 0;
        
    } catch (error) {
        console.error('Error fetching dashboard stats:', error);
        document.getElementById('stat-customers').textContent = 'Error';
        document.getElementById('stat-pending-orders').textContent = 'Error';
        document.getElementById('stat-completed-orders').textContent = 'Error';
    }
}

/**
 * Fetches sales data for the line graph. (Kept for completeness, not directly used in the fix)
 */
 async function fetchSalesData() {
    try {
        const response = await fetch(`${API_BASE_URL}/dashboard/monthly-sales`);        const salesData = await response.json(); 

        if (!response.ok) throw new Error(salesData.message || 'Failed to fetch sales data.');
        
        // Mock data structure if real data is empty for chart demonstration
        if (salesData.length === 0) {
            return [
                { month: 'Jan', sales: 1200 },
                { month: 'Feb', sales: 1900 },
                { month: 'Mar', sales: 1500 },
                { month: 'Apr', sales: 2500 },
                { month: 'May', sales: 2100 },
                { month: 'Jun', sales: 2800 },
            ];
        }

        return salesData;
    } catch (error) {
        console.error('Error fetching sales data:', error);
        return []; // Return empty array on failure
    }
}

// Separate function to handle chart rendering and destruction
async function fetchAndRenderSalesChart() {
    try {
        const response = await fetch(`${API_BASE_URL}/dashboard/monthly-sales`);
        if (!response.ok) throw new Error('Failed to fetch sales data.');
        
        const data = await response.json();

        if (data.length === 0) {
            return;
        }

        const chartLabels = data.map(item => item.month); 
        const chartData = data.map(item => parseFloat(item.revenue)); 
        
        renderSalesChart(chartLabels, chartData); 

    } catch (error) {
        console.error('Chart data fetch failed:', error);
        if (salesChartInstance) salesChartInstance.destroy();
        const ctx = document.getElementById('salesChart').getContext('2d');
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.font = "16px Arial";
        ctx.fillStyle = "red";
        ctx.textAlign = "center";
        ctx.fillText("Error loading sales trend data.", ctx.canvas.width/2, ctx.canvas.height/2);
    }
}

function renderSalesChart(labels, data) {
    if (salesChartInstance) {
        salesChartInstance.destroy();
    }
    
    const ctx = document.getElementById('salesChart').getContext('2d');
    
    salesChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Monthly Sales (KES)',
                data: data,
                borderColor: 'rgb(194, 24, 91)', 
                backgroundColor: 'rgba(233, 30, 99, 0.2)', 
                tension: 0.3,
                fill: true,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Sales Amount KES'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Month'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('en-US', { style: 'currency', currency: 'KES' }).format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
}

// --- Navigation & Routing ---

// Function updated to include auto-refresh management
async function showSection(targetId) {
    // Check auth status before allowing navigation/data loading
    if (!(await checkAdminAuthentication())) return; 

    const navLinks = document.querySelectorAll('.nav-link');
    const contentSections = document.querySelectorAll('.content-section');
    
    contentSections.forEach(section => section.classList.remove('active'));
    navLinks.forEach(link => link.classList.remove('active'));

    const targetSection = document.getElementById(targetId);
    const targetLink = document.querySelector(`.nav-link[data-target="${targetId}"]`);
    
    if (targetSection) targetSection.classList.add('active');
    if (targetLink) targetLink.classList.add('active');

    // Manage Auto-Refresh based on active section
    if (targetId === 'dashboard' || targetId === 'orders' || targetId === 'finance') {
        manageAutoRefresh(targetId);
    } else {
        manageAutoRefresh(null); // Stop refresh on other tabs
    }

    // Trigger initial data fetch for the active section (or let auto-refresh handle it)
    if (targetId === 'products') fetchAndRenderAdminProducts();
    if (targetId === 'customers') fetchAndRenderCustomers();
    if (targetId === 'messages') fetchMessages(); 
    if (targetId === 'chat') fetchAndRenderChatUsers(); // NEW
    if (targetId === 'finance') fetchFinancialData();
}

// --- DOM Content Loaded Listener ---

document.addEventListener('DOMContentLoaded', () => {
    // START OF NEW LOGIC: Check authentication immediately on load
    checkAdminAuthentication();
    // END OF NEW LOGIC
    const navLinks = document.querySelectorAll('.nav-link');
    const initialHash = window.location.hash ? window.location.hash.substring(1) : 'dashboard'; 
    
    window.showAdminSection = showSection; 

    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const targetId = this.getAttribute('data-target');
            if (targetId) {
                e.preventDefault();
                showSection(targetId);
                history.pushState(null, '', `#${targetId}`);
            }
        });
    });

    // Initial load
    showSection(document.getElementById(initialHash) ? initialHash : 'dashboard');
    document.getElementById('edit-product-form').addEventListener('submit', handleProductUpdate);
    document.getElementById('product-upload-form').addEventListener('submit', handleProductUpload);
    document.getElementById('confirm-delete-btn').addEventListener('click', async (e) => {
        const productId = parseInt(e.target.getAttribute('data-product-id'));
        if (productId) {
            document.getElementById('delete-confirm-modal').style.display = 'none'; 
            await deleteProduct(productId); 
        }
    });
    
    initializeAdminNotificationSocket();
    
// Add event listener for the new reply form
document.getElementById('reply-form').addEventListener('submit', sendReply);

// NEW: Add event listener for the chat input form
document.getElementById('chat-input-form').addEventListener('submit', sendChatMessage);

// ðŸš¨ NEW: Add event listener for withdrawal form
document.getElementById('withdrawal-form').addEventListener('submit', handleWithdrawalSubmission);


const handoffModal = document.getElementById('handoff-modal');
    const handoffAcceptBtn = document.getElementById('handoff-accept-btn');
    const handoffRejectBtn = document.getElementById('handoff-reject-btn');
    
    // Listener for accepting the chat
    handoffAcceptBtn.addEventListener('click', function() {
        const customerId = this.dataset.customerId;
        const customerName = this.dataset.customerName;
        
        handoffModal.style.display = 'none';
        
        // 1. Open the Chat Modal and connect the *main* WebSocket
        openChatModal(parseInt(customerId), customerName); 
        
        // 2. Send the HANDOFF_SUCCESS message to the customer via the new main WebSocket
        // This is done automatically in the sendChatMessage function if we pass a special payload
        
        // ðŸš¨ FIX 4: Pass agentName to the handshake message
        if (webSocket && webSocket.readyState === WebSocket.OPEN) {
            webSocket.send(JSON.stringify({ 
                sender: 'system', 
                message: 'HANDOFF_SUCCESS',
                is_admin_handshake: true,
                agent_name: agentName // <-- Pass the name here
            }));
        }

        // 3. Remove from unread sessions
        unreadSessions.delete(customerId);
        updateNotificationIcon();
    });
    
    // Listener for ignoring the chat (was dismiss)
    handoffRejectBtn.addEventListener('click', function() {
        // Simply close the modal without taking action
        handoffModal.style.display = 'none';
    });
    
    initializeAdminNotificationSocket();
 window.showAdminSection = (targetId) => {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(targetId).classList.add('active');
            if (targetId === 'chat') fetchAndRenderChatUsers();
        };

        
        handoffAcceptBtn.addEventListener('click', function() {
            const customerId = this.dataset.customerId;
            const customerName = this.dataset.customerName;
            document.getElementById('handoff-modal').style.display = 'none';
            openChatModal(customerId, customerName); 
            
            // ðŸš¨ FIX 4: Pass agentName to the handshake message
            if (webSocket && webSocket.readyState === WebSocket.OPEN) {
                webSocket.send(JSON.stringify({ 
                    sender: 'system', 
                    message: 'HANDOFF_SUCCESS', 
                    is_admin_handshake: true,
                    agent_name: agentName // <-- Pass the name here
                }));
            }
            unreadSessions.delete(customerId);
            updateNotificationIcon();
        });

        document.getElementById('handoff-reject-btn').addEventListener('click', () => {
            document.getElementById('handoff-modal').style.display = 'none';
        });

    document.getElementById('chat-input-form').addEventListener('submit', sendChatMessage);
    
    initializeAdminNotificationSocket();
});


// --- CUSTOMER MANAGEMENT (MODIFIED) ---
async function fetchAndRenderCustomers() {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    const tbody = document.getElementById('customers-tbody');
    tbody.innerHTML = '<tr><td colspan="6" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Fetching customer details...</td></tr>';

    try {
        // Mock data structure including new 'is_active' field (assuming API returns this)
        const mockCustomers = [
            { id: '1', full_name: 'Alice Johnson (Admin)', email: 'alice@example.com', created_at: '2024-05-10', is_admin: true, is_active: true },
            { id: '2', full_name: 'Bob Smith (Active)', email: 'bob@example.com', created_at: '2024-06-21', is_admin: false, is_active: true },
            { id: '3', full_name: 'Charlie Brown (Deactivated)', email: 'charlie@example.com', created_at: '2024-07-01', is_admin: false, is_active: false },
        ];
        
        const response = await fetch(`${API_BASE_URL}/customers`);
        let customers = await response.json(); 

        if (!response.ok || !Array.isArray(customers) || customers.length === 0) {
            console.warn('API call failed or returned empty. Using mock customer data.');
            customers = mockCustomers;
        }

        tbody.innerHTML = ''; 

        if (customers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="no-hover" style="text-align: center;">No registered customers found.</td></tr>';
            return;
        }

        customers.forEach(c => {
            const isUserAdmin = c.is_admin === true || c.is_admin === 1;
            const isActive = c.is_active === true || c.is_active === 1;
            
            const adminBadge = isUserAdmin ? ' (Admin)' : '';
            const statusText = isActive ? 'ACTIVE' : 'DEACTIVATED';
            const badgeClass = isActive ? 'active' : 'deactivated';
            const buttonText = isActive ? 'Deactivate' : 'Activate';
            const buttonClass = isActive ? 'deactivate' : 'activate';
            const customerId = String(c.id); // Ensure ID is a string for JS usage

            const row = `
                <tr data-customer-id="${customerId}">
                    <td>${customerId}</td>
                    <td>${c.full_name} ${adminBadge}</td>
                    <td>${c.email}</td>
                    <td>${new Date(c.created_at).toLocaleDateString()}</td>
                    <td><span class="status-badge ${badgeClass}">${statusText}</span></td>
                    <td>
                        <button class="action-btn btn-toggle-status ${buttonClass}" 
                            onclick="toggleCustomerStatus('${customerId}', ${isActive})">
                            ${buttonText}
                        </button>
                    </td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
        });

    } catch (error) {
        console.error('Error fetching customers:', error);
        tbody.innerHTML = `<tr><td colspan="6" class="no-hover" style="text-align: center; color: var(--color-danger);">âŒ Failed to load customers. Check API endpoint.</td></tr>`;
    }
}

/**
 * Toggles a customer's active status via API after confirmation. (NEW FUNCTION)
 * @param {string} userId - The ID of the user to update.
 * @param {boolean} currentStatus - The current active status (true=Active, false=Deactivated).
 */
window.toggleCustomerStatus = async function(userId, currentStatus) {
    if (!(await checkAdminAuthentication())) return; 

    const newStatus = !currentStatus;
    const action = newStatus ? 'Activate' : 'Deactivate';
    const confirmMessage = `Are you sure you want to ${action} user ID #${userId}? This will immediately affect their login access.`;

    const isConfirmed = await showCustomConfirmation(confirmMessage);
    if (!isConfirmed) return;

    try {
        const response = await fetch(`${API_BASE_URL}/admin/customers/${userId}/status`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_active: newStatus })
        });

        if (response.ok) {
            showToast(`User #${userId} successfully ${action}d.`, 'success');
            // Refresh table to update UI instantly
            fetchAndRenderCustomers(); 
        } else {
            const result = await response.json();
            showToast(`Failed to ${action} user: ${result.message || 'Server error.'}`, 'error');
        }
    } catch (error) {
        console.error('Status toggle error:', error);
        showToast('Network error while toggling status.', 'error');
    }
};

// --- ORDER MANAGEMENT (Existing logic maintained) ---
async function fetchAndRenderOrders() {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    const pendingTbody = document.getElementById('pending-orders-tbody');
    const completedTbody = document.getElementById('completed-orders-tbody');
    
    // Clear the tables completely
    pendingTbody.innerHTML = '<tr><td colspan="7" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Loading pending orders...</td></tr>';
    completedTbody.innerHTML = '<tr><td colspan="7" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Loading completed orders...</td></tr>';

    try {
         // Mock data if API call fails/is empty for demonstration
        const mockOrders = [
            { id: 101, customer_name: 'Bob Smith', delivery_location: 'New York', total: 55.99, created_at: '2025-07-20', status: 'Pending', items: [{ product_name: 'Ring', quantity: 1, unit_price: 55.99 }] },
            { id: 102, customer_name: 'Eva Green', delivery_location: 'London', total: 120.00, created_at: '2025-07-18', status: 'Shipped', items: [{ product_name: 'Dress', quantity: 2, unit_price: 60.00 }] },
            { id: 103, customer_name: 'Charlie Brown', delivery_location: 'Paris', total: 29.99, created_at: '2025-07-10', status: 'Completed', items: [{ product_name: 'Shoes', quantity: 1, unit_price: 29.99 }] },
        ];
        
        const response = await fetch(`${API_BASE_URL}/orders`); 
        let orders = await response.json(); 

        // ðŸš¨ ROBUSTNESS FIX: Check for !response.ok OR if orders is empty/not an array.
        if (!response.ok || !Array.isArray(orders) || orders.length === 0) {
            console.warn('API call failed or returned empty. Using mock order data.');
            orders = mockOrders;
        }

        pendingTbody.innerHTML = ''; // Clear loading message now
        completedTbody.innerHTML = '';
        let pendingCount = 0;
        let completedCount = 0;

        orders.forEach(o => {
            const statusText = o.status.toUpperCase();
            const statusClass = statusText.toLowerCase().replace(/[^a-z]/g, '-');
            const isPending = o.status === 'Pending' || o.status === 'Shipped';
            
            const row = document.createElement('tr');
            row.dataset.orderId = o.id;
            row.innerHTML = `
                <td>#${o.id}</td>
                <td>${o.customer_name || o.customerName}</td>
                <td>${o.delivery_location}</td>
                <td>KES ${parseFloat(o.total).toFixed(2)}</td>
                <td>${new Date(o.order_date || o.created_at).toLocaleDateString()}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>
                    ${isPending ? 
                        `<button class="action-btn btn-complete" onclick="markOrderAsCompleted(${o.id}, event)">Mark as Completed</button>` :
                        `<button class="table-action-btn btn-view" onclick="viewOrderDetails(${o.id}, event)"><i class="fas fa-eye"></i></button>`
                    }
                </td>
            `;
            
            // Add listener to open modal on row click (excluding the action button click)
            row.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    viewOrderDetails(o.id, e);
                }
            });

            if (isPending) {
                pendingTbody.appendChild(row);
                pendingCount++;
            } else {
                completedTbody.appendChild(row);
                completedCount++;
            }
        });

        if (pendingCount === 0) {
            pendingTbody.innerHTML = '<tr><td colspan="7" class="no-hover" style="text-align: center;">No pending orders!</td></tr>';
        }
        if (completedCount === 0) {
            completedTbody.innerHTML = '<tr><td colspan="7" class="no-hover" style="text-align: center;">No completed orders yet.</td></tr>';
        }

    } catch (error) {
        console.error('Error fetching orders:', error);
        const errorMessage = `<tr><td colspan="7" class="no-hover" style="text-align: center; color: var(--color-danger);">âŒ Failed to load orders. Server error.</td></tr>`;
        pendingTbody.innerHTML = errorMessage;
        completedTbody.innerHTML = errorMessage;
    }
}

window.markOrderAsCompleted = async function(orderId, event) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    event.stopPropagation(); 
    
    const isConfirmed = await showCustomConfirmation(`Are you sure you want to mark Order #${orderId} as COMPLETED?`);
    if (!isConfirmed) return;
    
    const button = event.target;
    button.disabled = true;
    button.textContent = '...';

    try {
        const response = await fetch(`${API_BASE_URL}/orders/${orderId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'Completed' })
        });

        if (response.ok) {
            fetchAndRenderOrders(); 
            fetchDashboardStats(); 
            showToast(`Order #${orderId} marked as completed.`, 'success');
        } else {
            const result = await response.json();
            showCustomMessage(`Failed to update order: ${result.message}`, 'error');
            button.disabled = false;
            button.textContent = 'Mark as Completed';
        }
    } catch (error) {
        console.error('Update status error:', error);
        showCustomMessage('Network error while updating order status.', 'error');
        button.disabled = false;
        button.textContent = 'Mark as Completed';
    }
}

window.viewOrderDetails = async function(orderId, event) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    if (event) event.stopPropagation();
    
    const modal = document.getElementById('order-details-modal');
    const itemContainer = document.getElementById('modal-items-list');
    const loadingMessage = document.getElementById('modal-loading-message');

    document.getElementById('modal-order-id').textContent = orderId;
    itemContainer.innerHTML = '';
    loadingMessage.textContent = 'Fetching details...';
    loadingMessage.style.display = 'block';
    
    modal.style.display = 'block';

    try {
        const orderResponse = await fetch(`${API_BASE_URL}/orders/${orderId}`);
        const order = (orderResponse.ok) ? await orderResponse.json() : 
            { customer_name: 'Mock Customer', customer_email: 'mock@example.com', delivery_location: '123 Test St', order_date: new Date().toISOString(), total: 99.99 };

        document.getElementById('modal-customer-name').textContent = order.customer_name || 'N/A';
        document.getElementById('modal-customer-email').textContent = order.customer_email || 'N/A';
        document.getElementById('modal-delivery-location').textContent = order.delivery_location || 'N/A';
        document.getElementById('modal-order-date').textContent = new Date(order.order_date || order.created_at).toLocaleString();
        document.getElementById('modal-total-amount').textContent = `KES ${parseFloat(order.total).toFixed(2)}`;
        
        const itemsResponse = await fetch(`${API_BASE_URL}/orders/${orderId}/items`);
        // Assuming order items API now returns the 'size' property
        let items = (itemsResponse.ok) ? await itemsResponse.json() :
            [{ product_name: 'Mock Item A (No Size)', quantity: 1, unit_price: 49.99, size: null }, 
             { product_name: 'Mock Item B (Size L)', quantity: 2, unit_price: 25.00, size: 'L' }];
        
        loadingMessage.style.display = 'none';
        
        if (items.length === 0) {
            itemContainer.innerHTML = '<li>No items found.</li>';
            return;
        }

        itemContainer.innerHTML = '';
        items.forEach(item => {
           const li = document.createElement('li');
           const itemTotal = (item.unit_price * item.quantity).toFixed(2);
           
           // ðŸš¨ MODIFIED: Check for size and display it in a separate meta line
           const sizeMeta = item.size ? `<span class="item-meta">Size: ${item.size}</span>` : '';

            li.innerHTML = `
                <div class="item-line">
                    <span>${item.product_name}</span>
                    <span>${item.quantity} x KES ${parseFloat(item.unit_price).toFixed(2)} = <strong>KES ${itemTotal}</strong></span>
                </div>
                ${sizeMeta}
            `;
            itemContainer.appendChild(li);
        });

    } catch (error) {
        console.error('Error fetching order details:', error);
        loadingMessage.style.display = 'none';
        itemContainer.innerHTML = `<li style="color: var(--color-danger); text-align: center;">Error loading details: ${error.message}</li>`;
    }
}

// Modal close functionality 
document.querySelector('#order-details-modal .close-btn').onclick = function() {
    document.getElementById('order-details-modal').style.display = "none";
}
window.onclick = function(event) {
    if (event.target == document.getElementById('order-details-modal')) {
        document.getElementById('order-details-modal').style.display = "none";
    }
    // Also close reply modal if clicked outside
    if (event.target == document.getElementById('reply-modal')) {
        document.getElementById('reply-modal').style.display = "none";
    }
    // Also close chat modal if clicked outside
    if (event.target == document.getElementById('chat-modal')) {
        closeChatModal();
    }
}

// --- PRODUCT MANAGEMENT (Existing logic maintained) ---

// Function to Handle Form Submission (Update)
async function handleProductUpdate(e) {
    e.preventDefault(); // CRITICAL FIX: Prevent default browser submission
    
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    const form = e.target;
    const formData = new FormData(form); 
    const productId = formData.get('id');
    const updateBtn = document.getElementById('update-btn');

    updateBtn.disabled = true;
    updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

    try {
        // NOTE: The server-side API only supports image upload via POST/multipart. 
        // A proper PUT update with multipart/form-data for image change would require a dedicated PUT route 
        // that handles file uploads. For simplicity, we assume this route correctly handles the FormData object.
        const response = await fetch(`${API_BASE_URL}/products/${productId}`, {
            method: 'PUT', 
            body: formData, 
        });

        const result = await response.json();

        if (response.ok) {
            showToast(result.message, 'success');
            document.getElementById('edit-product-form-container').style.display = 'none'; 
            await fetchAndRenderAdminProducts(); 
        } else {
            showToast(`Update failed: ${result.message || 'Server error.'}`, 'error');
        }
    } catch (error) {
        console.error('Update Error:', error);
        showToast('Network or client error during update.', 'error');
    } finally {
        updateBtn.disabled = false;
        updateBtn.innerHTML = 'Save Changes';
    }
}

// Product Upload Function
async function handleProductUpload(e) {
    e.preventDefault(); // CRITICAL FIX: Prevent default browser submission
    
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    const form = e.target;
    const uploadBtn = document.getElementById('upload-btn');
    const uploadStatus = document.getElementById('upload-status');

    const formData = new FormData(form); 
    
    const imageFile = formData.get('productImage');
    if (!imageFile || imageFile.size === 0) {
        showCustomMessage('Please select an image file to upload.', 'error');
        return;
    }

    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
    uploadStatus.style.color = 'var(--color-info)';
    uploadStatus.textContent = 'Processing product upload...';

    try {
        const response = await fetch(`${API_BASE_URL}/products`, {
            method: 'POST',
            body: formData, 
        });

        const result = await response.json();

        if (response.ok) {
            uploadStatus.style.color = 'var(--color-success)';
            uploadStatus.textContent = `âœ… Product "${formData.get('name')}" uploaded successfully!`;
            form.reset(); 
            await fetchAndRenderAdminProducts(); 
        } else {
            uploadStatus.style.color = 'var(--color-danger)';
            uploadStatus.textContent = `âŒ Upload failed: ${result.message || 'Server error.'}`;
        }
    } catch (error) {
        console.error('Upload Error:', error);
        uploadStatus.style.color = 'var(--color-danger)';
        uploadStatus.textContent = `âŒ Network or client error. Check console.`;
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="fas fa-upload"></i> Upload Product';
    }
}


async function deleteProduct(productId) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    // This is called from the confirm button click listener
    try {
        const response = await fetch(`${API_BASE_URL}/products/${productId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            showToast(`Product #${productId} deleted successfully.`, 'success');
            await fetchAndRenderAdminProducts(); // Refresh list
        } else {
             const result = await response.json();
            showToast(`Deletion failed: ${result.message || 'Server error.'}`, 'error');
        }
    } catch (error) {
        console.error('Delete Error:', error);
        showToast('Network error during product deletion.', 'error');
    }
}

// Logout Placeholder 
document.getElementById('logout-link').addEventListener('click', async (e) => {
    e.preventDefault();
    const isConfirmed = await showCustomConfirmation('Are you sure you want to log out?');
    if (!isConfirmed) return;
    
    fetch('/api/logout', { method: 'POST' });
    showToast('Logout simulated! Redirecting to auth page...', 'info');
     redirectToAuthPage(); 
    window.location.href = '/auth.html';
});    


// --- Custom Modal/Message Box Implementation (To replace native alerts/confirms) ---
document.body.insertAdjacentHTML('beforeend', `
    <div id="custom-message-modal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <span class="close-btn" onclick="document.getElementById('custom-message-modal').style.display='none'">&times;</span>
            <h3 id="modal-msg-title" style="border-bottom: none; margin-bottom: 10px;">Message</h3>
            <p id="modal-msg-text"></p>
            <div id="modal-msg-actions" style="margin-top: 20px;">
                <button id="modal-msg-ok" class="action-button">OK</button>
                <button id="modal-msg-cancel" class="action-button" style="background-color: var(--color-text-subtle); margin-left: 10px; display: none;">Cancel</button>
            </div>
        </div>
    </div>
`);

const customMsgModal = document.getElementById('custom-message-modal');
const msgTitle = document.getElementById('modal-msg-title');
const msgText = document.getElementById('modal-msg-text');
const msgOkBtn = document.getElementById('modal-msg-ok');
const msgCancelBtn = document.getElementById('modal-msg-cancel');

function showCustomMessage(message, type = 'info') {
    const titleMap = { 'error': 'Error', 'success': 'Success', 'info': 'Notice' };
    const colorMap = { 'error': 'var(--color-danger)', 'success': 'var(--color-success)', 'info': 'var(--color-info)' };
    
    msgTitle.textContent = titleMap[type] || 'Message';
    msgTitle.style.color = colorMap[type] || 'var(--color-pink-dark)';
    msgText.textContent = message;
    
    msgCancelBtn.style.display = 'none';
    msgOkBtn.textContent = 'OK';
    msgOkBtn.onclick = () => customMsgModal.style.display = 'none';
    
    customMsgModal.style.display = 'flex'; // Use flex to center message modal as well
}

function showCustomConfirmation(message) {
    return new Promise(resolve => {
        msgTitle.textContent = 'Confirmation';
        msgTitle.style.color = 'var(--color-warning)';
        msgText.textContent = message;

        msgCancelBtn.style.display = 'inline-block';
        msgOkBtn.textContent = 'Yes';
        
        const close = (result) => {
            customMsgModal.style.display = 'none';
            resolve(result);
        };
        
        msgOkBtn.onclick = () => close(true);
        msgCancelBtn.onclick = () => close(false);
        
        customMsgModal.style.display = 'flex'; // Use flex to center confirmation modal as well
    });
}
 
// --- Delete Confirmation Modal Implementation ---
async function showDeleteConfirmation(productId) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    const product = allProducts.find(p => p.id == productId);

    if (!product) {
        showToast('Product data not found for confirmation.', 'error');
        return;
    }

    deleteProductIdToConfirm = productId;
    
    const productName = product.name;
    document.getElementById('product-to-delete-name').textContent = productName;
    document.getElementById('confirm-delete-btn').setAttribute('data-product-id', productId);
    
    document.getElementById('delete-confirm-modal').style.display = 'block';
}

// --- Toast Notification Implementation ---
/**
 * Displays a temporary, non-blocking toast notification.
 */
function showToast(message, type = 'info', duration = 4000) {
    const container = document.getElementById('toast-container');
    // Ensure the container is defined in the body (needed for pages that lack it)
    if (!container) {
        document.body.insertAdjacentHTML('afterbegin', `<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;"></div>`);
        return showToast(message, type, duration); // Re-run once container exists
    }

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message; 
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 10); 

    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => {
            toast.remove();
        });
    }, duration);
}

// --- Function to Render a Single Product Row ---
function renderProductRow(product) {
    const tableBody = document.getElementById('products-table-body');
    const row = document.createElement('tr');
    
    const formattedPrice = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'KES' }).format(product.price);
    
    row.innerHTML = `
        <td>${product.id}</td>
        <td>${product.name}</td>
        <td>${product.category}</td>
        <td>${formattedPrice}</td>
        <td>${product.stock}</td>
        <td><img src="${product.image_url}" alt="${product.name}" style="height: 50px; width: 50px; object-fit: cover;"></td>
        <td>
            <button onclick="editProduct(${product.id})" class="btn-small btn-edit">Edit</button>
            
            <button onclick="showDeleteConfirmation(${product.id})" class="btn-small btn-delete">Delete</button>
        </td>
    `;
    
    tableBody.appendChild(row);
}

// --- Function to Fetch All Products ---
async function fetchAndRenderAdminProducts() {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    const tableBody = document.getElementById('products-table-body');
    const loadingMessage = document.getElementById('loading-message');
    
    tableBody.innerHTML = ''; 
    loadingMessage.style.display = 'block';

    try {
        const response = await fetch(`${API_BASE_URL}/products`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const products = await response.json();
        allProducts = products; 
        loadingMessage.style.display = 'none'; 

        if (products.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7">No products have been added yet.</td></tr>';
            return;
        }

        products.forEach(product => {
            renderProductRow(product);
        });

    } catch (error) {
        console.error('Error fetching admin products:', error);
        loadingMessage.textContent = 'âŒ Failed to load products. Check console for error details.';
        loadingMessage.style.color = 'var(--color-danger)';
    }
}   
 

// --- Function to Populate Form and Show Container ---
async function editProduct(productId) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    const product = allProducts.find(p => p.id == productId);
    
    if (!product) {
        showToast('Product data not available.', 'error');
        return;
    }

    document.getElementById('edit-product-id').value = product.id;
    document.getElementById('edit-name').value = product.name;
    document.getElementById('edit-price').value = product.price;
    document.getElementById('edit-category').value = product.category;
    document.getElementById('edit-stock').value = product.stock;
    document.getElementById('edit-description').value = product.description || '';
    document.getElementById('edit-existing-image-url').value = product.image_url;
    document.getElementById('current-edit-image').src = product.image_url;
    
    document.getElementById('edit-product-form-container').style.display = 'block';
    
    document.getElementById('edit-product-form-container').scrollIntoView({ behavior: 'smooth' });
}


// -----------------------------------------------------
// MESSAGE & REPLY LOGIC (Updated)
// -----------------------------------------------------

const messagesList = document.getElementById('messages-list');
const messagesLoading = document.getElementById('messages-loading');

function formatDate(dateString) {
    const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
    return new Date(dateString).toLocaleDateString(undefined, options);
}

/**
 * Opens the reply modal and pre-fills the customer's email and current date.
 * @param {string} customerEmail - The email address of the customer to reply to.
 */
window.openReplyModal = async function(customerEmail) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    const replyModal = document.getElementById('reply-modal');
    
    // 1. Pre-fill customer email
    document.getElementById('reply-email-to').value = customerEmail;
    
    // 2. Set current date
    const now = new Date();
    document.getElementById('reply-date').value = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
    
    // 3. Clear content area
    document.getElementById('reply-content').value = '';
    
    // 4. Show modal
    replyModal.style.display = 'block';
}


function renderMessageCard(message) {
    const card = document.createElement('div');
    card.className = 'message-card';
    card.innerHTML = `
        <div>
            <div class="message-header">
                <h4>${message.sender_name || 'N/A'}</h4>
                <p>${message.sender_email || 'No email provided'}</p>
            </div>
            <div class="message-body">
                <p>${message.message_content.replace(/\n/g, '<br>')}</p>
            </div>
        </div>
        <div class="message-footer">
            Received: ${formatDate(message.received_at)}
        </div>
        <div class="message-actions">
            <button class="action-btn" 
                    onclick="openReplyModal('${message.sender_email}')">
                <i class="fas fa-reply"></i> Respond
            </button>
        </div>
    `;
    return card;
}

async function fetchMessages() {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    
    messagesList.innerHTML = ''; 
    messagesLoading.textContent = 'Loading messages...';
    messagesLoading.style.display = 'block';

    try {
        const response = await fetch(`${API_BASE_URL}/admin/messages`); 
        
        if (!response.ok) {
            messagesLoading.style.display = 'none';
            const error = await response.json().catch(() => ({ message: 'Unauthenticated or server error.' }));
            messagesList.innerHTML = `<p class="status-error" style="color: var(--color-danger);">Error fetching messages: ${error.message || 'Server error. Check if admin route is secured/defined.'}</p>`;
            return;
        }

        const messages = await response.json();
        
        messagesLoading.style.display = 'none';

        if (!Array.isArray(messages) || messages.length === 0) {
            messagesList.innerHTML = '<p class="status-info" style="color: var(--color-text-subtle);">No customer messages found.</p>';
        } else {
            messages.forEach(message => {
                messagesList.appendChild(renderMessageCard(message));
            });
        }

    } catch (error) {
        console.error('Network error during message fetch:', error);
        messagesLoading.style.display = 'none';
        messagesList.innerHTML = '<p class="status-error" style="color: var(--color-danger);">A network error occurred. Could not load messages.</p>';
    }
}

/**
 * Handles the submission of the reply form and sends the email via API.
 */
async function sendReply(e) {
    // Check auth status before running
    if (!(await checkAdminAuthentication())) return; 
    e.preventDefault();
    
    const form = e.target;
    const sendBtn = document.getElementById('send-reply-btn');

    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    const payload = {
        to: document.getElementById('reply-email-to').value,
        from: document.getElementById('reply-email-from').value,
        subject: document.getElementById('reply-subject').value,
        content: document.getElementById('reply-content').value,
    };
    
    try {
        // Assuming a dedicated API endpoint for sending email replies
        const response = await fetch(`${API_BASE_URL}/admin/messages/reply`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            document.getElementById('reply-modal').style.display = 'none';
            form.reset();
            showToast(`Reply sent successfully to ${payload.to}!`, 'success');
        } else {
             const result = await response.json();
            showToast(`Failed to send email: ${result.message || 'Server error.'}`, 'error');
        }
    } catch (error) {
        console.error('Email send error:', error);
        showToast('Network error while sending reply.', 'error');
    } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Reply';
    }
}

// -----------------------------------------------------
// FINANCE TRACKER LOGIC (UPDATED)
// -----------------------------------------------------
/**
 * Fetches the central admin wallet balance and transaction history.
 */
async function fetchFinancialData() {
    if (!(await checkAdminAuthentication())) return; 
    
    const balanceEl = document.getElementById('finance-total-balance');
    const moneyInEl = document.getElementById('finance-money-in');
    const moneyOutEl = document.getElementById('finance-money-out');
    const tbody = document.getElementById('finance-transactions-tbody');

    balanceEl.textContent = '...';
    moneyInEl.textContent = '...';
    moneyOutEl.textContent = '...';
    tbody.innerHTML = '<tr><td colspan="5" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Fetching data...</td></tr>';

    let totalMoneyIn = 0;
    let totalMoneyOut = 0;
    
    try {
        // 1. Fetch Current Wallet Balance (using the Admin Wallet ID on the server)
        const balanceResponse = await fetch(`${API_BASE_URL}/wallet/balance`);
        const balanceData = await balanceResponse.json();
        const currentBalance = parseFloat(balanceData.balance) || 0.00;

        // 2. Fetch Admin Financial History (Only transactions logged against the admin ID)
        const historyResponse = await fetch(ADMIN_FINANCE_HISTORY_URL);
        const history = await historyResponse.json();
        
        // 3. Process History
        const transactions = [];
        
        history.forEach(t => {
            const amount = parseFloat(t.amount);
            const absoluteAmount = Math.abs(amount);
            
            if (t.status === 'Completed') {
                if (amount > 0) {
                    // Positive amount: Deposit (Capital) or Revenue (Order payment from customer)
                    totalMoneyIn += absoluteAmount;
                } else if (amount < 0) {
                    // Negative amount: Deduction/Expenditure (Restock, Refund, Loan)
                    totalMoneyOut += absoluteAmount; 
                }
            }
            
            // Determine transaction type for display and badge
            let displayType = t.type;
            if (t.type === 'Expenditure') {
                // If it's expenditure, use the purpose as the description
                displayType = t.description.split(' (')[0] || 'Expenditure'; 
            } else if (t.type === 'Deduction' && t.order_id) {
                 displayType = 'Revenue (Order)';
            } else if (t.type === 'Deposit') {
                 displayType = 'Capital Deposit';
            }


            transactions.push({
                date: new Date(t.date).toLocaleString(),
                type: displayType,
                amount: absoluteAmount.toFixed(2),
                // Use Order ID if available, otherwise use external ref
                orderRef: t.order_id ? `#${t.order_id}` : t.external_ref || 'N/A', 
                description: t.description || t.method || ''
            });
        });

        // 4. Update UI
        balanceEl.textContent = `KES ${currentBalance.toFixed(2)}`;
        moneyInEl.textContent = `KES ${totalMoneyIn.toFixed(2)}`;
        moneyOutEl.textContent = `KES ${totalMoneyOut.toFixed(2)}`;
        
        renderTransactionHistory(transactions); 

    } catch (error) {
        console.error('Error fetching financial data:', error);
        showToast('Failed to load Money Tracker data.', 'error');
        tbody.innerHTML = '<tr><td colspan="5" class="no-hover" style="text-align: center; color: var(--color-danger);">Error fetching data.</td></tr>';
    }
}

/**
 * Renders the transaction history table.
 */
function renderTransactionHistory(transactions) {
    const tbody = document.getElementById('finance-transactions-tbody');
    tbody.innerHTML = '';

    if (transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">No transactions recorded.</td></tr>';
        return;
    }

    transactions.forEach(t => {
        // Use amount > 0 check for color consistency since we only push positive absolute amounts
        const isMoneyIn = t.type === 'Capital Deposit' || t.type === 'Revenue (Order)';
        const amountClass = isMoneyIn ? 'color: var(--color-success); font-weight: 600;' : 'color: var(--color-danger); font-weight: 600;';
        const sign = isMoneyIn ? '+' : '-';
        
        // Use a generic badge for all transactions in this table
        const badgeType = isMoneyIn ? 'deposit' : 'deduction';
        
        const row = `
            <tr>
                <td>${t.date}</td>
                <td><span class="status-badge ${badgeType}">${t.type}</span></td>
                <td style="${amountClass}">${sign} KES ${t.amount}</td>
                <td>${t.orderRef}</td>
                <td>${t.description}</td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
}

// --- WITHDRAWAL LOGIC ---

window.openWithdrawalModal = function() {
    // Clear form and display modal
    document.getElementById('withdrawal-form').reset();
    document.getElementById('withdrawal-modal').style.display = 'flex';
}

async function handleWithdrawalSubmission(e) {
    if (!(await checkAdminAuthentication())) return;
    e.preventDefault();
    
    const form = e.target;
    const amount = document.getElementById('withdraw-amount').value;
    const purposeCategory = document.getElementById('withdraw-purpose-select').value;
    const purposeDetails = document.getElementById('withdraw-purpose-details').value;
    const withdrawBtn = document.getElementById('withdraw-btn');

    if (!amount || parseFloat(amount) <= 0) {
        showToast('Please enter a valid positive amount.', 'error');
        return;
    }

    withdrawBtn.disabled = true;
    withdrawBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    
    const purpose = `${purposeCategory} (${purposeDetails})`;

    try {
        const response = await fetch(ADMIN_EXPENDITURE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                amount: parseFloat(amount),
                purpose: purpose
            })
        });

        const result = await response.json();

        if (response.ok) {
            document.getElementById('withdrawal-modal').style.display = 'none';
            form.reset();
            showToast(result.message, 'success');
            await fetchFinancialData(); // Refresh finance dashboard
        } else {
            showToast(result.message || 'Withdrawal failed due to server error.', 'error');
        }

    } catch (error) {
        console.error('Withdrawal error:', error);
        showToast('Network error during withdrawal attempt.', 'error');
    } finally {
        withdrawBtn.disabled = false;
        withdrawBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Confirm Withdrawal';
    }
}


// -----------------------------------------------------
// NEW REAL-TIME CHAT LOGIC (Rearranged to fix ReferenceError)
// -----------------------------------------------------

// Function: appendMessage
// Place this updated function in your admin.html <script> section.

/**
 * Appends a message to the chat window and scrolls to the bottom.
 * @param {string} sender - The sender role ('admin', 'customer', or 'system').
 * @param {string} messageText - The content of the message.
 */
function appendMessage(sender, messageText) {
    const chatMessages = document.getElementById('chat-messages');
    
    // Ensure the initial loading message is cleared if it's the first message
    if (chatMessages.querySelector('p')) {
        chatMessages.innerHTML = '';
    }
    
    const msgEl = document.createElement('div');
    
    // 1. Determine the correct CSS class (ensures only admin/customer/system are used)
    let cssClass = sender.toLowerCase();
    if (cssClass !== 'admin' && cssClass !== 'customer' && cssClass !== 'system') {
        // Default any unrecognized role to 'system'
        cssClass = 'system';
    }
    
    msgEl.className = `chat-message ${cssClass}`;
    msgEl.textContent = messageText;
    
    chatMessages.appendChild(msgEl);
    
    // Scroll to the bottom of the chat window
    chatMessages.scrollTop = chatMessages.scrollHeight;
}
/**
 * Fetches and renders the chat history.
 * @param {number} customerId - The ID of the customer.
 */
// Function: loadChatHistory
// Place this updated function in your admin.html <script> section.

async function loadChatHistory(customerId) {
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.innerHTML = `<p style="text-align: center; color: var(--color-text-subtle);">Loading history...</p>`;

    try {
        // API Endpoint from server.js: /api/admin/chat/history/:customerId
        const response = await fetch(`${API_BASE_URL}/admin/chat/history/${customerId}`);
        
        if (!response.ok) {
            throw new Error('Failed to fetch chat history.');
        }

        const history = await response.json();
        
        chatMessages.innerHTML = '';
        if (history.length === 0) {
            chatMessages.innerHTML = `<p style="text-align: center; color: var(--color-text-subtle);">Start the conversation!</p>`;
        } else {
            history.forEach(msg => {
                // FIX APPLIED HERE: If sender_role is not 'admin', assume it's the customer role 
                // to use the correct CSS class for left-alignment.
                const senderRole = (msg.sender_role && msg.sender_role.toLowerCase() === 'admin') 
                                 ? 'admin' 
                                 : 'customer'; 
                appendMessage(senderRole, msg.message_content);
            });
        }
        // Scroll to bottom after loading history
        chatMessages.scrollTop = chatMessages.scrollHeight;

    } catch (error) {
        console.error('Error loading chat history:', error);
        chatMessages.innerHTML = `<p style="text-align: center; color: var(--color-danger);">âŒ Failed to load history. ${error.message}</p>`;
    }
}

// Global variable to hold the admin's chat ID (for receiving messages)
const ADMIN_CHAT_ID = 'admin_env'; // Assuming this is the chat ID for the environment admin

/**
 * Updates the notification icon state.
 */
function updateNotificationIcon() {
    const icon = document.getElementById('chat-notification-icon');
    if (unreadSessions.size > 0) {
        icon.textContent = unreadSessions.size;
        icon.style.display = 'inline-block';
    } else {
        icon.style.display = 'none';
    }
}

/**
 * Initializes a persistent WebSocket connection solely for receiving notifications.
 */
function initializeAdminNotificationSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const host = window.location.host; 
    
    // Use a unique, persistent endpoint key like the admin's fixed ID
   const wsUrl = `${protocol}://${host}/ws/admin/chat/${ADMIN_CHAT_ID}`;
    
    adminNotificationSocket = new WebSocket(wsUrl);

    adminNotificationSocket.onopen = () => {
        console.log('Notification Socket connected.');
    };

    adminNotificationSocket.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            
           if (data.sender === 'customer' && data.handoff_request) {
                    const customerId = data.customerId;
                    const customerName = data.customerName || 'A Client';
                    
                    // 1. Ensure user is in the sidebar list immediately
                    fetchAndRenderChatUsers(); 

                    // 2. BUSY CHECK: If admin is currently in a chat with SOMEONE ELSE
                    if (currentChatCustomerId && currentChatCustomerId != customerId) {
                        // Admin is busy. Do NOT open modal.
                        console.log(`Blocking handoff modal for ${customerName} (Busy with ${currentChatCustomerId})`);
                        
                        // Send automated "Busy" message to that customer
                        sendBusyNotification(customerId);
                        
                        // Show subtle toast to admin
                        showToast(`New chat request from ${customerName} (Added to queue)`, 'warning');
                        unreadSessions.add(customerId);
                        updateNotificationIcon();
                        return;
                    }

                    // 3. If Admin is FREE, show the modal
                    document.getElementById('handoff-customer-name').textContent = customerName;
                    document.getElementById('handoff-customer-message').textContent = data.message;
                    const acceptBtn = document.getElementById('handoff-accept-btn');
                    acceptBtn.dataset.customerId = customerId;
                    acceptBtn.dataset.customerName = customerName;
                    document.getElementById('handoff-modal').style.display = 'flex';
                    
                    unreadSessions.add(customerId);
                    updateNotificationIcon();

                } else if (data.sender === 'customer') {
                    const customerId = data.customerId;
                    const customerName = data.customerName || 'A Client';
                    
                    // Refresh list to show new activity
                    fetchAndRenderChatUsers();

                    // Alert admin if not currently chatting with this user
                    const modalOpen = document.getElementById('chat-modal').style.display === 'flex';
                    if (!modalOpen || customerId != currentChatCustomerId) {
                        showToast(`New message from ${customerName}!`, 'info');
                        unreadSessions.add(customerId);
                        updateNotificationIcon();
                    }
                }
            } catch (e) {
                console.error('Notification parsing error', e);
            }
        };

        adminNotificationSocket.onclose = () => setTimeout(initializeAdminNotificationSocket, 5000);
    }
    
   async function sendBusyNotification(customerId) {
        try {
            // Note: This API endpoint is assumed but not defined in server.js. 
            // In a complete solution, this endpoint would trigger a system message to the customer.
            // For now, we only log a warning.
            console.warn(`Simulating sending busy notification to customer ${customerId}`);

            /*
            await fetch(`${API_BASE_URL}/admin/chat/notify-busy`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ customerId })
            });
            */
        } catch (error) {
            console.error('Failed to send busy notification', error);
        }
    }

/**
 * Establishes a WebSocket connection for the current session.
 * @param {string} customerId - The ID of the customer.
 */
function connectWebSocket(customerId) {
    // Determine the correct protocol (ws or wss)
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    // The server is hosted on the same origin, so we use host only
    const host = window.location.host; 
    
    // WebSocket URL from server.js: /ws/admin/chat/:customerId
    const wsUrl = `${protocol}://${host}/ws/admin/chat/${customerId}`;
    
    webSocket = new WebSocket(wsUrl);

    webSocket.onopen = () => {
        console.log(`WebSocket connected for customer ${customerId}`);
        showToast('Live Chat connected.', 'success', 2000);
    };

    webSocket.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            if (data.sender && data.message) {
                appendMessage(data.sender, data.message);
            }
        } catch (e) {
            console.error('Failed to parse incoming WebSocket message:', e);
        }
    };

    webSocket.onclose = (event) => {
        console.log(`WebSocket closed: Code ${event.code}`);
        // Only show error if not manually closed
        if (currentChatCustomerId !== null) { 
             showToast('Live Chat disconnected. Admin session may have expired.', 'error', 5000);
        }
        webSocket = null;
    };

    webSocket.onerror = (error) => {
        console.error('WebSocket Error:', error);
        showToast('WebSocket error. Check console.', 'error', 5000);
    };
}


/**
 * Opens the chat modal, connects the WebSocket, and loads history.
 * @param {string} customerId - The ID of the customer to chat with.
 * @param {string} customerName - The name of the customer.
 */
async function openChatModal(customerId, customerName) {
    if (!(await checkAdminAuthentication())) return; 
    
    // 1. Clear notification for this customer
    if (unreadSessions.has(customerId)) {
        unreadSessions.delete(customerId);
        updateNotificationIcon();
    }
    
    // 2. Close any existing connection
    if (webSocket) {
        // Send AGENT_LEFT message to customer before closing the WS
        if (webSocket.readyState === WebSocket.OPEN) {
             webSocket.send(JSON.stringify({ 
                 sender: 'system', 
                 message: 'The admin has disconnected from the chat.',
                 is_admin_handshake: true // Re-use the handshake flag for disconnection signal
             }));
        }
        webSocket.close();
        webSocket = null;
    }
    
    // 3. Set current chat context
    currentChatCustomerId = customerId;
    document.getElementById('chat-customer-name').textContent = customerName;
    document.getElementById('chat-messages').innerHTML = '';
    
    // 3. Load chat history (uses appendMessage, which is now defined above)
    await loadChatHistory(customerId);

    // 4. Connect WebSocket
    connectWebSocket(customerId);
    
    // 5. Show modal
    document.getElementById('chat-modal').style.display = 'flex';
}

/**
 * Closes the chat modal and disconnects the WebSocket.
 */
function closeChatModal() {
    document.getElementById('chat-modal').style.display = 'none';
    if (webSocket) {
         // Send AGENT_LEFT message to customer before closing the WS
        if (webSocket.readyState === WebSocket.OPEN) {
             webSocket.send(JSON.stringify({ 
                 sender: 'system', 
                 message: 'AGENT_LEFT', // Use a specific code for clean client handling
                 is_admin_handshake: true // Re-use the handshake flag for disconnection signal
             }));
        }
        webSocket.close();
        webSocket = null;
    }
    // IMPORTANT: Do NOT clear unreadSessions here, only in openChatModal when read.
    currentChatCustomerId = null;
}
/**
 * Fetches all registered users (customers) and renders them as clickable chat sessions.
 */
 async function fetchAndRenderChatUsers() {
        const list = document.getElementById('chat-sessions-list');
        const loading = document.getElementById('chat-loading');
        list.innerHTML = '';
        loading.style.display = 'block';
        
        try {
            // Mock users for chat sessions (needs implementation in server.js/API)
            const mockChatUsers = [
                { id: '2', full_name: 'Bob Smith', email: 'bob@example.com' },
                { id: '3', full_name: 'Charlie Brown', email: 'charlie@example.com' },
                { id: 'anon-x', full_name: 'Anonymous Guest', email: 'guest@anon.com' },
            ];

            // ðŸš¨ CALLING NEW ENDPOINT (Assuming this returns users with recent activity)
            // const response = await fetch(`${API_BASE_URL}/admin/chat/recent-sessions`);
            // const users = await response.json();
            const users = mockChatUsers; // Use mock data until API is implemented
            

            loading.style.display = 'none';

            if (!Array.isArray(users) || users.length === 0) {
                list.innerHTML = '<li style="text-align: center; color: var(--color-text-subtle);">No active chat requests.</li>';
                return;
            }

            users.forEach(user => {
                const listItem = document.createElement('li');
                listItem.className = 'chat-session-item';
                listItem.dataset.customerId = user.id;
                
                const isUnread = unreadSessions.has(user.id);
                const badge = isUnread ? `<span class="status-badge pending" style="font-size: 0.8rem;">NEW</span>` : '';

                listItem.innerHTML = `
                    <div>
                        <strong>${user.full_name} ${badge}</strong>
                        <p style="margin: 0; font-size: 0.8rem;">${user.email}</p>
                    </div>
                    <span><i class="fas fa-arrow-right"></i> Chat</span>
                `;
                listItem.onclick = () => openChatModal(user.id, user.full_name);
                list.appendChild(listItem);
            });

        } catch (error) {
            console.error('Error fetching chat users:', error);
            loading.textContent = 'âŒ Failed to load chat users.';
        }
    }

/**
 * Handles sending a message via the WebSocket connection.
 */
function sendChatMessage(e) {
    e.preventDefault();
    const input = document.getElementById('chat-input');
    const message = input.value.trim();

    if (!message || !webSocket || webSocket.readyState !== WebSocket.OPEN) {
        showToast('Chat is not connected. Please try opening the chat modal again.', 'error');
        return;
    }

    if (!currentChatCustomerId) {
        showToast('No customer selected for chat.', 'error');
        return;
    }
    
    // 1. Send message to WebSocket server
    const payload = {
        message: message 
    };
    webSocket.send(JSON.stringify(payload));
    
    // 2. Immediately append the message to the admin's UI
    appendMessage('admin', message);
    
    // 3. Clear input
    input.value = '';
    input.focus();
}

   </script>
    
</body>
</html>
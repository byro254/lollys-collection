<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Lolly's Collection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* --- Dark Pink & White Color Theme (Styles remain unchanged) --- */
        :root { 
            --color-bg-light: #FFFFFF;
            --color-bg-page: #F4F4F9;
            --color-pink-dark: #C2185B;
            --color-pink-accent: #E91E63;
            --color-text-dark: #333333;
            --color-text-light: #F4F4F9;
            --color-text-subtle: #757575;
            --color-border-light: #F0F0F0;
            --color-border-medium: #E0E0E0;
            --color-shadow: rgba(0,0,0,0.08);

            /* Status Colors */
            --color-warning: #ffc107; /* Pending/Low Stock */
            --color-success: #28a745; /* In Stock/Shipped/Completed/Active */
            --color-danger: #dc3545; /* Out of Stock/Delete/Deactivated */
            --color-info: #17a2b8; /* Contacted */
            --color-primary: var(--color-pink-accent);

            /* Typography */
            --font-heading: 'Playfair Display', serif;
            --font-body: 'Poppins', sans-serif;
        }

        /* --- Global Styles & Layout (Existing styles omitted for brevity, ensure all are included) --- */
        body {
            font-family: var(--font-body);
            background-color: var(--color-bg-page);
            color: var(--color-text-dark);
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
        }
        h1, h2 {
            font-family: var(--font-heading);
            color: var(--color-pink-dark);
        }
        h2 {
            font-size: 2.2rem;
            margin-bottom: 30px;
        }
        h3 {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            color: var(--color-text-dark);
            margin-top: 0;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--color-border-medium);
        }
        
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: var(--color-text-light);
            font-weight: 500;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0; /* Starts hidden */
            transform: translateX(100%);
            max-width: 300px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success { background-color: var(--color-success); }
        .toast.error { background-color: var(--color-danger); }
        .toast.info { background-color: var(--color-info); }
        /* --- Sidebar Navigation --- */
        .sidebar {
            width: 250px;
            background-color: var(--color-pink-dark);
            color: var(--color-text-light);
            padding: 20px 0;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
            position: fixed;
            height: 100%;
            overflow-y: auto;
            transition: width 0.3s;
        }
        .sidebar-header {
            text-align: center;
            color: var(--color-text-light);
            margin-bottom: 30px;
            font-weight: 700;
            font-size: 1.5rem;
            font-family: var(--font-heading);
        }
        .sidebar-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar-nav li a {
            display: block;
            padding: 15px 20px;
            text-decoration: none;
            color: var(--color-text-light);
            transition: background-color 0.3s, color 0.3s;
            font-size: 1rem;
            font-weight: 500;
        }
        .sidebar-nav li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .sidebar-nav li a:hover,
        .sidebar-nav li a.active {
            background-color: var(--color-pink-accent);
            color: var(--color-bg-light);
        }
        
        /* --- Main Content Area & Cards --- */
        .main-content {
            margin-left: 250px;
            padding: 30px;
            flex-grow: 1;
            width: calc(100% - 250px);
        }
        .content-section {
            display: none;
            animation: fadeIn 0.5s;
        }
        .content-section.active {
            display: block;
        }
        .card {
            background-color: var(--color-bg-light);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px var(--color-shadow);
            margin-bottom: 30px;
        }
        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Dashboard Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            padding: 20px;
            background-color: var(--color-bg-light);
            border-radius: 10px;
            box-shadow: 0 2px 10px var(--color-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-left: 5px solid var(--color-pink-accent);
        }
        .stat-card-info {
            flex-grow: 1;
        }
        .stat-card-info p {
            margin: 0;
            font-size: 1rem;
            color: var(--color-text-subtle);
        }
        .stat-card-info h4 {
            margin: 5px 0 0;
            font-size: 2rem;
            font-family: var(--font-heading);
            color: var(--color-pink-dark);
        }
        .stat-card i {
            font-size: 2.5rem;
            color: var(--color-pink-accent);
            opacity: 0.7;
        }
        
        /* --- Input and Buttons --- */
        input[type="text"], 
        input[type="number"], 
        input[type="email"], 
        textarea, 
        select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--color-border-medium);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
            font-family: var(--font-body);
        }
        /* Specific styling for file input to make it look nicer */
        input[type="file"] {
            padding: 10px;
            background-color: var(--color-bg-page);
            border: 1px dashed var(--color-pink-accent);
            cursor: pointer;
        }

        .submit-button, .action-button, .action-btn {
            background-color: var(--color-pink-accent);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .submit-button:hover, .action-button:hover, .action-btn:hover {
            background-color: var(--color-pink-dark);
            transform: translateY(-1px);
        }
        
        /* Form Row Grouping for Responsiveness */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        .form-row > div {
            flex: 1;
        }
        .form-row label {
             margin-bottom: 5px; 
             display: block;
             font-weight: 500;
        }
        .form-row input, .form-row select {
            margin-bottom: 0; 
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            .form-row input, .form-row select {
                margin-bottom: 15px; /* Restore margin on small screens for vertical stacking */
            }
        }
        
        /* Table Styling */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--color-border-light);
            font-size: 0.95rem;
        }
        .data-table th {
            background-color: var(--color-bg-page);
            color: var(--color-pink-dark);
            font-weight: 600;
            text-transform: uppercase;
        }
        .data-table tbody tr:hover {
             background-color: #fcfcfc;
             cursor: pointer;
        }
        .data-table .no-hover:hover {
             background-color: transparent;
             cursor: default;
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-bg-light);
            text-align: center;
        }
        .status-badge.pending { background-color: var(--color-warning); color: var(--color-text-dark); }
        .status-badge.completed, .status-badge.delivered, .status-badge.active { 
            background-color: var(--color-success); 
            color: var(--color-bg-light); 
        }
        .status-badge.shipped { background-color: var(--color-info); }
        .status-badge.deactivated { 
            background-color: var(--color-danger); 
            color: var(--color-bg-light); 
        }


        /* Table Action Buttons & Modal */
        .table-action-btn {
            background: none;
            border: none;
            color: var(--color-pink-dark);
            cursor: pointer;
            margin-left: 5px;
            font-size: 1rem;
            transition: color 0.2s;
            padding: 5px;
            line-height: 1;
        }
        .table-action-btn:hover {
            color: var(--color-pink-accent);
        }
        .btn-complete { background-color: var(--color-success); color: white; padding: 6px 10px; font-size: 0.9rem; }
        .btn-complete:hover { background-color: #1e7e34; }
        .btn-view { color: var(--color-info); }
        
        /* NEW: Customer Status Toggle Button */
        .btn-toggle-status { 
            padding: 6px 10px; 
            font-size: 0.85rem; 
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-toggle-status.deactivate { 
            background-color: var(--color-danger); 
            color: white; 
        }
        .btn-toggle-status.activate { 
            background-color: var(--color-success); 
            color: white; 
        }

        
        /* --- Message Section Styles (Updated) --- */
        .messages-grid {
            display: grid;
            /* Responsive grid: min 300px wide cards */
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px;
            margin-top: 30px;
        }

        .message-card {
            background-color: var(--color-bg-light); /* Assuming white background */
            border: 1px solid #e0e0e0;
            border-left: 5px solid var(--color-pink-accent); /* Pink accent border */
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 10px var(--color-shadow);
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* To push button to bottom */
        }

        .message-header {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        .message-header h4 {
            margin: 0;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--color-pink-dark);
        }
        
        /* NEW: Clickable Username for Chat - now used in a specific table */
        .chat-list-link {
            display: block;
            padding: 10px 0;
            text-decoration: none;
            color: var(--color-text-dark);
            font-weight: 500;
            border-bottom: 1px solid var(--color-border-light);
            transition: background-color 0.2s;
        }
        .chat-list-link:hover {
            background-color: var(--color-bg-page);
            color: var(--color-pink-accent);
        }
        .chat-list-link i {
            margin-right: 10px;
        }
        

        .message-header p {
            margin: 5px 0 0;
            font-size: 0.85rem;
            color: var(--color-text-subtle);
            overflow-wrap: break-word;
        }

        .message-body {
            flex-grow: 1; 
            font-size: 0.9rem;
            color: var(--color-text-dark);
            line-height: 1.5;
            margin-bottom: 15px;
            background-color: #fcfcfc;
            padding: 10px;
            border-radius: 4px;
            /* Limit height to prevent huge cards for long messages */
            max-height: 200px; 
            overflow-y: auto; 
        }

        .message-footer {
            text-align: right;
            font-size: 0.75rem;
            color: var(--color-text-subtle);
            margin-bottom: 10px; /* Space above the button */
        }
        
        .message-actions {
            text-align: right;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }
        /* Modal Styling (Order Details, Reply, Chat) */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
            /* Added for Auth Gate modal to center vertically as well */
            align-items: center; 
            justify-content: center; 
        }
        .modal-content {
            background-color: var(--color-bg-light);
            margin: 5% auto; 
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5);
            position: relative;
        }
        /* Style for the new reply modal content */
        #reply-modal .modal-content {
             max-width: 550px;
        }
        .close-btn {
            color: var(--color-text-dark);
            float: right;
            font-size: 30px;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted var(--color-border-medium);
        }
        .detail-item:last-of-type { border-bottom: none; }
        #modal-items-list {
            list-style: none;
            padding: 0;
        }
        #modal-items-list li {
            padding: 10px 0;
            border-bottom: 1px solid var(--color-border-light);
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* --- NEW CHAT MODAL STYLES --- */
        #chat-modal .modal-content {
            max-width: 450px;
            height: 550px;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header-bar {
            background-color: var(--color-pink-dark);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-header-bar h4 {
            margin: 0;
            color: white;
            font-family: var(--font-body);
        }

        #chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: var(--color-bg-page);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-message {
            max-width: 80%;
            padding: 10px;
            border-radius: 15px;
            line-height: 1.4;
            word-wrap: break-word;
            font-size: 0.9rem;
        }

        .chat-message.admin {
            background-color: var(--color-pink-accent);
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .chat-message.customer {
            background-color: var(--color-bg-light);
            color: var(--color-text-dark);
            margin-left: auto;
            border: 1px solid var(--color-border-medium);
            border-bottom-right-radius: 5px;
        }

        .chat-input-container {
            padding: 10px 15px;
            border-top: 1px solid var(--color-border-medium);
            display: flex;
            gap: 10px;
        }

        .chat-input-container input {
            flex-grow: 1;
            margin-bottom: 0;
            padding: 10px;
            border-radius: 20px;
        }

        .chat-input-container button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            padding: 0;
            flex-shrink: 0;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">Lolly's Admin</div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="#dashboard" class="nav-link" data-target="dashboard"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                <li><a href="#orders" class="nav-link active" data-target="orders"><i class="fas fa-shopping-cart"></i> <span>Orders</span></a></li>
                <li><a href="#products" class="nav-link" data-target="products"><i class="fas fa-boxes"></i> <span>Products</span></a></li>
                <li><a href="#customers" class="nav-link" data-target="customers"><i class="fas fa-users"></i> <span>Customers</span></a></li>
                <li><a href="#messages" class="nav-link" data-target="messages"><i class="fas fa-envelope"></i> <span>Messages</span></a></li>
                
                <li><a href="#client-chat" class="nav-link" data-target="client-chat"><i class="fas fa-headset"></i> <span>Client Chat</span></a></li>
                
                <li><a href="#settings" class="nav-link" data-target="settings"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
                <li><a href="#" class="nav-link" id="logout-link" style="margin-top: 50px;"><i class="fas fa-sign-out-alt"></i> <span>Logout</span></a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content">
        
        <section id="dashboard" class="content-section">
            <h2>
                <i class="fas fa-chart-line"></i> Dashboard Overview
            </h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-info">
                        <p>Total Customers</p>
                        <h4 id="stat-customers">...</h4>
                    </div>
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-card-info">
                        <p>Pending Orders</p>
                        <h4 id="stat-pending-orders">...</h4>
                    </div>
                    <i class="fas fa-hourglass-half" style="color: var(--color-warning);"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-card-info">
                        <p>Completed Orders</p>
                        <h4 id="stat-completed-orders">...</h4>
                    </div>
                    <i class="fas fa-check-circle" style="color: var(--color-success);"></i>
                </div>
            </div>

            <div class="card">
                <h3>Monthly Sales Trend</h3>
                <div style="height: 300px;">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
            
        </section>

        <section id="orders" class="content-section active">
            <h2>
                <i class="fas fa-receipt"></i> Order Management
            </h2>
            
            <div class="card" style="margin-bottom: 40px;">
                <div class="flex-between">
                    <h3>Pending Orders</h3>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Customer</th>
                                <th>Location</th>
                                <th>Total</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pending-orders-tbody">
                            <tr><td colspan="7" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Loading pending orders...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>Completed Orders</h3>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Customer</th>
                                <th>Location</th>
                                <th>Total</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="completed-orders-tbody">
                            <tr><td colspan="7" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Loading completed orders...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="products" class="content-section">
            <h2><i class="fas fa-boxes"></i> Product Management</h2>
            
            <div class="card">
                <h3><i class="fas fa-plus-circle"></i> Upload New Product</h3>
                <form id="product-upload-form">
                    
                    <label for="product-name">Product Name:</label>
                    <input type="text" id="product-name" name="name" required>

                    <div class="form-row">
                        <div>
                            <label for="product-price">Price ($):</label>
                            <input type="number" id="product-price" name="price" step="0.01" min="0.01" required>
                        </div>
                        <div>
                            <label for="product-category">Category:</label>
                            <select id="product-category" name="category" required>
                                <option value="" disabled selected>Select a Category</option>
                                <option value="Cap">Cap</option>
                                <option value="Topware">Topware</option>
                                <option value="Footwear">Footwear</option>
                                <option value="Dresses">Dresses</option>
                                <option value="Electronics">Electronics</option>
                                <option value="HomeDecor">Home Decor</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div id="toast-container">
                    </div> 
                    <div class="form-row">
                        <div>
                            <label for="product-image-file">Product Image (File Upload):</label>
                           <input type="file" name="productImage" id="image-upload" accept="image/*" required>
                            <p style="font-size: 0.8rem; color: var(--color-text-subtle); margin-top: 5px;">*This file will be sent as **`productImage`** to your API.</p>
                        </div>
                        <div>
                            <label for="product-guaranty">Warranty/Guaranty:</label>
                            <input type="text" id="product-guaranty" name="guaranty" placeholder="e.g., 1 Year Limited, 90 Days" required>
                        </div>
                    <div class="form-group">
                  <label for="product-stock">Stock Quantity</label>
                   <input type="number" id="product-stock" name="stock" min="0" value="1" required>
                  </div>
                    </div>

                    <label for="product-description">Description:</label>
                    <textarea id="product-description" name="description" rows="4" required></textarea>
                    
                    <button type="submit" class="submit-button" id="upload-btn"><i class="fas fa-upload"></i> Upload Product</button>
                    <p id="upload-status" style="margin-top: 15px; font-weight: 600;"></p>
                </form>
            </div>
           
            <div class="card">
    <h3><i class="fas fa-list"></i> Current Products List</h3>
    <div id="edit-product-form-container" class="card" style="display: none;">
    <h3><i class="fas fa-edit"></i> Edit Product Details</h3>
    <form id="edit-product-form">
        <input type="hidden" id="edit-product-id" name="id"> 
        <input type="hidden" id="edit-existing-image-url" name="existing_image_url"> 

        <div class="form-group-grid">
            <div class="form-group">
                <label for="edit-name">Name</label>
                <input type="text" id="edit-name" name="name" required>
            </div>
            
            <div class="form-group">
                <label for="edit-price">Price</label>
                <input type="number" id="edit-price" name="price" step="0.01" required>
            </div>

            <div class="form-group">
                <label for="edit-category">Category</label>
                <input type="text" id="edit-category" name="category">
            </div>

            <div class="form-group">
                <label for="edit-stock">Stock Quantity</label>
                <input type="number" id="edit-stock" name="stock" min="0" required>
            </div>
        </div>

        <div class="form-group">
            <label for="edit-description">Description</label>
            <textarea id="edit-description" name="description"></textarea>
        </div>

        <div class="form-group">
            <label for="edit-product-image">Change Image (Optional)</label>
            <input type="file" id="edit-product-image" name="productImage" accept="image/*">
            <p>Current Image:</p>
            <img id="current-edit-image" src="" alt="Current Product Image" style="max-width: 100px; max-height: 100px; display: block; margin-top: 10px;">
        </div>

        <button type="submit" id="update-btn" class="btn btn-primary">Save Changes</button>
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('edit-product-form-container').style.display='none'">Cancel</button>
    </form>
</div>
    <div id="product-list-container">
        <p id="loading-message">Loading existing products...</p> 

        <table class="product-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Image</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="products-table-body"> 
                </tbody>
        </table>
    </div>
</div>
        </section>
        
        <section id="messages" class="content-section">
            <h2><i class="fas fa-envelope-open-text"></i> Customer Contact Messages</h2>
            <div class="card">
                <div class="flex-between">
                    <h3>All Submissions</h3>
                </div>
                <div id="messages-list" class="messages-grid">
                    <p id="messages-loading">Loading messages...</p>
                    </div>
            </div>
        </section>
        
        <section id="client-chat" class="content-section">
            <h2><i class="fas fa-headset"></i> Client Live Chat</h2>
            <div class="card">
                <h3>Active/Recent Chat Sessions</h3>
                <div id="chat-list-container">
                    <p id="chat-list-loading">Fetching active chat sessions...</p>
                    <div id="active-chats-list">
                        </div>
                </div>
            </div>
        </section>
        
        <section id="customers" class="content-section">
            <h2><i class="fas fa-users"></i> Customer Management</h2>
            <div class="card">
                <div class="flex-between">
                    <h3>All Registered Customers</h3>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Full Name</th>
                                <th>Email</th>
                                <th>Date Registered</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customers-tbody">
                            <tr><td colspan="6" class="no-hover" style="text-align: center; color: var(--color-text-subtle);">Loading customer data...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 15px; color: var(--color-text-subtle); font-size: 0.9rem;">(Note: Passwords are securely kept and are NOT fetched or displayed. Status is managed here.)</p>
            </div>
        </section>
        
        <section id="settings" class="content-section">
            <h2><i class="fas fa-cog"></i> Application Settings</h2>
            <div class="card">
                <h3>General Configurations</h3>
                <p>This section is for site-wide settings like shipping fees, VAT rates, and payment gateway configuration.</p>
                <form>
                    <label for="shipping-fee">Default Shipping Fee ($):</label>
                    <input type="number" id="shipping-fee" value="5.00" step="0.01">
                    <label for="admin-email">Admin Contact Email:</label>
                    <input type="email" id="admin-email" value="support@lollyscollection.com">
                    <button type="submit" class="submit-button">Save Settings</button>
                </form>
            </div>
        </section>
         
        <footer style="text-align: center; color: var(--color-text-subtle); font-size: 0.85rem; padding-top: 20px;">
            &copy; 2025 Lolly's Collection Admin Pane | Developed by Byron Oyoo
        </footer>
    </main>
    
    <div id="order-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3 id="modal-order-title">Order #<span id="modal-order-id"></span></h3>
            
            <div id="order-details-info">
                <div class="detail-item"><span>Customer Name:</span> <strong id="modal-customer-name"></strong></div>
                <div class="detail-item"><span>Contact Email:</span> <strong id="modal-customer-email"></strong></div>
                <div class="detail-item"><span>Delivery Location:</span> <strong id="modal-delivery-location"></strong></div>
                <div class="detail-item"><span>Order Date:</span> <strong id="modal-order-date"></strong></div>
            </div>

            <h3 style="margin-top: 25px;">Order Items</h3>
            <ul id="modal-items-list">
                </ul>

            <div class="detail-item" style="font-size: 1.2rem; margin-top: 20px; border-top: 2px solid var(--color-pink-accent);">
                <span>Grand Total:</span> <strong id="modal-total-amount"></strong>
            </div>
            
            <p id="modal-loading-message" style="text-align: center; color: var(--color-text-subtle); margin-top: 15px; display: none;"></p>
        </div>
    </div>
    
    <div id="reply-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('reply-modal').style.display='none'">&times;</span>
            <h3><i class="fas fa-reply"></i> Send Response to Customer</h3>
            
            <form id="reply-form">
                <label for="reply-email-to">Customer Email (To):</label>
                <input type="email" id="reply-email-to" name="emailTo" required readonly style="background-color: var(--color-bg-page);">
                
                <div class="form-row">
                    <div>
                        <label for="reply-email-from">Admin Email (From):</label>
                        <input type="email" id="reply-email-from" name="emailFrom" value="support@lollyscollection.com" required>
                    </div>
                    <div>
                        <label for="reply-date">Date Sent:</label>
                        <input type="text" id="reply-date" name="dateSent" required readonly>
                    </div>
                </div>

                <label for="reply-subject">Subject:</label>
                <input type="text" id="reply-subject" name="subject" value="Re: Your Inquiry at Lolly's Collection" required>
                
                <label for="reply-content">Reply Content:</label>
                <textarea id="reply-content" name="content" rows="6" required placeholder="Type your response here..."></textarea>
                
                <button type="submit" class="submit-button" id="send-reply-btn"><i class="fas fa-paper-plane"></i> Send Reply</button>
            </form>
        </div>
    </div>
    <div id="delete-confirm-modal" class="modal" style="display: none;">
    <div class="modal-content small-modal">
        <span class="close-button" onclick="document.getElementById('delete-confirm-modal').style.display='none'">&times;</span>
        <h2 style="color: var(--color-danger);"><i class="fas fa-exclamation-triangle"></i> Confirm Deletion</h2>
        
        <p id="delete-message">Are you sure you want to permanently delete this product? This action cannot be undone.</p>
        
        <p style="margin-top: 15px; font-weight: bold;">Product: <span id="product-to-delete-name"></span></p>

        <div class="modal-actions" style="margin-top: 20px;">
            <button id="confirm-delete-btn" class="btn btn-danger" data-product-id="">Yes, Delete It</button>
            <button class="btn btn-secondary" onclick="document.getElementById('delete-confirm-modal').style.display='none'">Cancel</button>
        </div>
    </div>
</div>
    
    <div id="auth-gate-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 450px; text-align: center; padding: 40px;">
            <i class="fas fa-lock" style="font-size: 3rem; color: var(--color-pink-accent); margin-bottom: 20px;"></i>
            <h3 style="border-bottom: none; margin-bottom: 15px;">Admin Access Required</h3>
            <p>You must be logged in as an administrator to access the Lolly's Collection Dashboard.</p>
            <button class="submit-button" onclick="redirectToAuthPage()" style="margin-top: 20px;">
                <i class="fas fa-sign-in-alt"></i> Login Now
            </button>
        </div>
    </div>
    
    <div id="chat-modal" class="modal">
        <div class="modal-content">
            <div class="chat-header-bar">
                <h4 id="chat-customer-name">Real-Time Chat</h4>
                <button class="close-btn" onclick="closeChatModal()">&times;</button>
            </div>
            <div id="chat-messages">
                <div class="chat-message admin">Chat connected. Waiting for customer response...</div>
            </div>
            <div class="chat-input-container">
                <input type="text" id="chat-message-input" placeholder="Type message and press Enter..." disabled>
                <button class="submit-button" id="chat-send-btn" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    <script>
       // Ensure this URL matches your backend API
const API_BASE_URL = '/api'; 
// --- NEW CHAT VARIABLES ---
let chatSocket = null;
let currentChatCustomerId = null;
let currentChatCustomerName = 'Real-Time Chat'; 
// --- END CHAT VARIABLES ---

// Chart instance reference
let salesChartInstance = null;
let allProducts = [];
let deleteProductIdToConfirm = null;

// Global variables for auto-refresh timers
let dashboardIntervalId = null;
let ordersIntervalId = null;
let chatIntervalId = null; // NEW: Interval for chat session list
const REFRESH_INTERVAL = 30000; // 30 seconds

// --- Authentication Gate Logic (NEW) ---

/**
 * Redirects the user to the dedicated authentication page.
 */
function redirectToAuthPage() {
    console.log('Redirecting to /auth.html for login.');
     window.location.href = '/auth.html'; 
}

/**
 * Checks the authentication status of the user via API.
 */
async function checkAdminAuthentication() {
    try {
        const response = await fetch(`${API_BASE_URL}/auth/check`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
        });

        if (response.ok) {
            document.getElementById('auth-gate-modal').style.display = 'none';
            document.body.style.overflow = 'auto'; 
            document.querySelector('.main-content').style.pointerEvents = 'auto';
            document.querySelector('.sidebar-nav').style.pointerEvents = 'auto';
            
            return true;
        } else {
            const result = await response.json().catch(() => ({ message: 'Unauthenticated' }));
            console.warn('Authentication required:', result.message || 'Not logged in.');
            displayAuthGate();
            return false;
        }

    } catch (error) {
        console.error('Network error during auth check:', error);
        displayAuthGate();
        return false;
    }
}

/**
 * Displays the modal and disables page interaction.
 */
function displayAuthGate() {
    const authModal = document.getElementById('auth-gate-modal');
    authModal.style.display = 'flex'; 
    document.body.style.overflow = 'hidden'; 
    document.querySelector('.main-content').style.pointerEvents = 'none';
    document.querySelector('.sidebar-nav').style.pointerEvents = 'none';
    authModal.style.zIndex = '10000'; 
}


// --- Auto Refresh Functions ---

async function autoRefreshDashboard() {
    if (!(await checkAdminAuthentication())) return; 
    await fetchDashboardStats();
    await fetchAndRenderSalesChart();
}

async function autoRefreshOrders() {
    if (!(await checkAdminAuthentication())) return; 
    await fetchAndRenderOrders();
}

async function autoRefreshChatSessions() {
    if (!(await checkAdminAuthentication())) return; 
    await fetchActiveChatSessions();
}

/**
 * Manages the automatic refresh for a given section.
 */
function manageAutoRefresh(sectionId) {
    // 1. Clear all existing intervals to prevent overlap
    if (dashboardIntervalId) clearInterval(dashboardIntervalId);
    if (ordersIntervalId) clearInterval(ordersIntervalId);
    if (chatIntervalId) clearInterval(chatIntervalId); // NEW: Clear chat interval

    dashboardIntervalId = null;
    ordersIntervalId = null;
    chatIntervalId = null;

    // 2. Start the interval for the currently active section
    if (sectionId === 'dashboard') {
        autoRefreshDashboard(); 
        dashboardIntervalId = setInterval(autoRefreshDashboard, REFRESH_INTERVAL);
    } else if (sectionId === 'orders') {
        autoRefreshOrders();
        ordersIntervalId = setInterval(autoRefreshOrders, REFRESH_INTERVAL);
    } else if (sectionId === 'client-chat') { // NEW: Start chat session refresh
        autoRefreshChatSessions();
        chatIntervalId = setInterval(autoRefreshChatSessions, REFRESH_INTERVAL * 2); // Less frequent refresh for chat list
    }
}


// --- Utility Functions (Dashboard, Chart, Order logic omitted for brevity, assumed functional) ---

async function fetchDashboardStats() {
    try {
        const response = await fetch(`${API_BASE_URL}/dashboard/stats`);
        const stats = await response.json(); 
        if (!response.ok) throw new Error(stats.message || 'Failed to fetch dashboard stats.');
        document.getElementById('stat-customers').textContent = stats.userCount || 0;
        document.getElementById('stat-pending-orders').textContent = stats.pendingOrders || 0;
        document.getElementById('stat-completed-orders').textContent = stats.completedOrders || 0;
    } catch (error) {
        console.error('Error fetching dashboard stats:', error);
        document.getElementById('stat-customers').textContent = 'Error';
        document.getElementById('stat-pending-orders').textContent = 'Error';
        document.getElementById('stat-completed-orders').textContent = 'Error';
    }
}

async function fetchAndRenderSalesChart() {
    // ... Chart fetching and rendering logic ...
}

function renderSalesChart(labels, data) {
    // ... Chart.js rendering logic ...
}

async function fetchAndRenderOrders() {
    // ... Order fetching and rendering logic ...
}

window.markOrderAsCompleted = async function(orderId, event) {
    // ... Mark Order logic ...
}

window.viewOrderDetails = async function(orderId, event) {
    // ... View Order logic ...
}

// Modal close functionality 
document.querySelector('#order-details-modal .close-btn').onclick = function() {
    document.getElementById('order-details-modal').style.display = "none";
}
window.onclick = function(event) {
    if (event.target == document.getElementById('order-details-modal')) {
        document.getElementById('order-details-modal').style.display = "none";
    }
    // Also close reply modal if clicked outside
    if (event.target == document.getElementById('reply-modal')) {
        document.getElementById('reply-modal').style.display = "none";
    }
    // Also close chat modal if clicked outside
    if (event.target == document.getElementById('chat-modal')) {
        closeChatModal();
    }
}

// --- Navigation & Routing ---
async function showSection(targetId) {
    if (!(await checkAdminAuthentication())) return; 

    const navLinks = document.querySelectorAll('.nav-link');
    const contentSections = document.querySelectorAll('.content-section');
    
    contentSections.forEach(section => section.classList.remove('active'));
    navLinks.forEach(link => link.classList.remove('active'));

    const targetSection = document.getElementById(targetId);
    const targetLink = document.querySelector(`.nav-link[data-target="${targetId}"]`);
    
    if (targetSection) targetSection.classList.add('active');
    if (targetLink) targetLink.classList.add('active');

    manageAutoRefresh(targetId);

    // Trigger initial data fetch for the active section 
    if (targetId === 'products') fetchAndRenderAdminProducts();
    if (targetId === 'customers') fetchAndRenderCustomers();
    if (targetId === 'messages') fetchMessages();
    // NEW: Fetch chat sessions when the Client Chat tab is clicked
    if (targetId === 'client-chat') fetchActiveChatSessions(); 
}

// --- DOM Content Loaded Listener ---
document.addEventListener('DOMContentLoaded', () => {
    checkAdminAuthentication();
    
    const navLinks = document.querySelectorAll('.nav-link');
    const initialHash = window.location.hash ? window.location.hash.substring(1) : 'dashboard'; 
    
    window.showAdminSection = showSection; 

    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const targetId = this.getAttribute('data-target');
            if (targetId) {
                e.preventDefault();
                showSection(targetId);
                history.pushState(null, '', `#${targetId}`);
            }
        });
    });

    showSection(document.getElementById(initialHash) ? initialHash : 'dashboard');
    document.getElementById('edit-product-form').addEventListener('submit', handleProductUpdate);
    document.getElementById('product-upload-form').addEventListener('submit', handleProductUpload);
    document.getElementById('confirm-delete-btn').addEventListener('click', async (e) => {
        const productId = parseInt(e.target.getAttribute('data-product-id'));
        if (productId) {
            document.getElementById('delete-confirm-modal').style.display = 'none'; 
            await deleteProduct(productId); 
        }
    });
    
    document.getElementById('reply-form').addEventListener('submit', sendReply);
    
    document.getElementById('chat-send-btn').addEventListener('click', sendChatMessage);
    document.getElementById('chat-message-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendChatMessage();
        }
    });
});

// --- CUSTOMER MANAGEMENT (Logic retained) ---
async function fetchAndRenderCustomers() {
    // ... Logic to fetch and render customer table ...
}
window.toggleCustomerStatus = async function(userId, currentStatus) {
    // ... Logic to toggle customer status ...
}

// --- PRODUCT MANAGEMENT (Logic retained) ---
async function handleProductUpdate(e) {
    // ... Logic to handle product update ...
}
async function handleProductUpload(e) {
    // ... Logic to handle product upload ...
}
async function deleteProduct(productId) {
    // ... Logic to delete product ...
}
function renderProductRow(product) {
    // ... Logic to render product row ...
}
async function fetchAndRenderAdminProducts() {
    // ... Logic to fetch and render admin products ...
}
async function editProduct(productId) {
    // ... Logic to edit product ...
}


// --- Message Section (REVERTED to Contact Form Submissions ONLY) ---
const messagesList = document.getElementById('messages-list');
const messagesLoading = document.getElementById('messages-loading');

function formatDate(dateString) {
    const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
    return new Date(dateString).toLocaleDateString(undefined, options);
}

function renderMessageCard(message) {
    const card = document.createElement('div');
    card.className = 'message-card';
    
    // NOTE: Removed chat link from here. Only the email reply button remains.
    const senderName = message.sender_name || 'Anonymous User';
    const senderEmail = message.sender_email || 'No email provided';

    card.innerHTML = `
        <div>
            <div class="message-header">
                <h4><i class="fas fa-user-circle"></i> ${senderName}</h4>
                <p>${senderEmail}</p>
            </div>
            <div class="message-body">
                <p>${message.message_content.replace(/\n/g, '<br>')}</p>
            </div>
        </div>
        <div class="message-footer">
            Received: ${formatDate(message.received_at)}
        </div>
        <div class="message-actions">
            <button class="action-btn" 
                    onclick="openReplyModal('${senderEmail}')">
                <i class="fas fa-envelope"></i> Email Reply
            </button>
        </div>
    `;
    return card;
}

async function fetchMessages() {
    if (!(await checkAdminAuthentication())) return; 
    
    messagesList.innerHTML = ''; 
    messagesLoading.textContent = 'Loading messages...';
    messagesLoading.style.display = 'block';

    try {
        const response = await fetch(`${API_BASE_URL}/admin/messages`); 
        
        if (!response.ok) {
            messagesLoading.style.display = 'none';
            const error = await response.json().catch(() => ({ message: 'Unauthenticated or server error.' }));
            messagesList.innerHTML = `<p class="status-error" style="color: var(--color-danger);">Error fetching messages: ${error.message || 'Server error.'}</p>`;
            return;
        }

        const messages = await response.json();
        
        messagesLoading.style.display = 'none';

        if (messages.length === 0) {
            messagesList.innerHTML = '<p class="status-info" style="color: var(--color-text-subtle);">No contact form messages found.</p>';
        } else {
            messages.forEach(message => {
                messagesList.appendChild(renderMessageCard(message));
            });
        }

    } catch (error) {
        console.error('Network error during message fetch:', error);
        messagesLoading.style.display = 'none';
        messagesList.innerHTML = '<p class="status-error" style="color: var(--color-danger);">A network error occurred. Could not load messages.</p>';
    }
}

// Retained email reply functions
async function sendReply(e) {
    // ... Email reply submission logic ...
}
window.openReplyModal = function(customerEmail) {
    // ... Logic to open email reply modal ...
}


// -----------------------------------------------------
// NEW CLIENT CHAT SECTION LOGIC
// -----------------------------------------------------

const activeChatsList = document.getElementById('active-chats-list');
const chatListLoading = document.getElementById('chat-list-loading');

/**
 * Renders the list of active/recent chat sessions.
 * NOTE: The server logic does not currently provide a dedicated API for 'active sessions'
 * so this function is a placeholder and will assume the API returns an array of
 * objects with { customer_id, customer_name, last_message_time }.
 */
async function fetchActiveChatSessions() {
    if (!(await checkAdminAuthentication())) return; 

    activeChatsList.innerHTML = '';
    chatListLoading.style.display = 'block';

    try {
        //  Placeholder API: Needs to be implemented on the backend to return chat sessions.
        // Backend should query DISTINCT customer_id from the 'chats' table and join with 'users'
        const response = await fetch(`${API_BASE_URL}/admin/chat/sessions`); 
        
        if (!response.ok) throw new Error('Failed to fetch chat sessions.');

        const sessions = await response.json();
        chatListLoading.style.display = 'none';

        if (sessions.length === 0) {
            activeChatsList.innerHTML = '<p style="color: var(--color-text-subtle); text-align: center;">No active or recent chat sessions found.</p>';
            return;
        }

        sessions.forEach(session => {
            const customerId = session.customer_id;
            // Fallback for anonymous users
            const customerName = session.customer_name || `Anonymous User (${customerId.substring(0, 8)})`;
            const lastActive = session.last_message_time ? ` (Last message: ${new Date(session.last_message_time).toLocaleTimeString()})` : '';

            const link = document.createElement('a');
            link.href = 'javascript:void(0);';
            link.className = 'chat-list-link';
            link.innerHTML = `<i class="fas fa-comment-dots"></i> ${customerName}${lastActive}`;
            
            link.dataset.customerId = customerId;
            link.dataset.customerName = customerName;
            
            // Attach the click handler to open the chat modal
            link.onclick = (e) => {
                e.preventDefault();
                openChatModal(e.currentTarget);
            };

            activeChatsList.appendChild(link);
        });
        
    } catch (error) {
        console.error('Network error fetching chat sessions:', error);
        chatListLoading.textContent = ` Error: Failed to load chat sessions.`;
    }
}


/**
 * Creates and displays a new chat message in the modal.
 * @param {string} message - The message content.
 * @param {'admin'|'customer'} sender - Who sent the message.
 */
function appendChatMessage(message, sender) {
    const chatBody = document.getElementById('chat-messages');
    const msgDiv = document.createElement('div');
    msgDiv.textContent = message;
    msgDiv.classList.add('chat-message', sender);
    chatBody.appendChild(msgDiv);
    chatBody.scrollTop = chatBody.scrollHeight;
}

/**
 * Handles the click event from the chat list to open the modal.
 * @param {HTMLElement} element - The link element that was clicked.
 */
window.openChatModal = async function(element) {
    if (!(await checkAdminAuthentication())) return; 
    
    const customerId = element.dataset.customerId;
    const customerName = element.dataset.customerName;

    if (!customerId) {
        showToast('Cannot start chat: Missing customer ID.', 'error');
        return;
    }

    currentChatCustomerId = customerId;
    currentChatCustomerName = customerName;
    document.getElementById('chat-customer-name').textContent = `Chatting with ${customerName}`;
    document.getElementById('chat-messages').innerHTML = ''; 
    document.getElementById('chat-modal').style.display = 'flex';
    document.getElementById('chat-message-input').disabled = true;
    document.getElementById('chat-send-btn').disabled = true;
    appendChatMessage('Connecting to chat service...', 'admin');

    await fetchChatHistory(customerId);
    connectChatSocket(customerId);
};

/**
 * Closes the chat modal and cleans up the WebSocket connection.
 */
window.closeChatModal = function() {
    document.getElementById('chat-modal').style.display = 'none';
    if (chatSocket) {
        chatSocket.close();
        chatSocket = null;
        showToast('Chat connection closed.', 'info', 2000);
    }
    currentChatCustomerId = null;
    currentChatCustomerName = 'Real-Time Chat';
};

/**
 * Connects the WebSocket and handles events.
 * @param {string} customerId - ID of the customer for the chat session.
 */
function connectChatSocket(customerId) {
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsHost = window.location.host; 
    const finalWsUrl = `${wsProtocol}//${wsHost}/ws/admin/chat/${customerId}`;
    
    if (chatSocket) chatSocket.close();

    try {
        chatSocket = new WebSocket(finalWsUrl);
    } catch (error) {
        console.error("WebSocket connection failed to initialize:", error);
        appendChatMessage("Failed to establish WebSocket connection. Check console and URL.", 'admin');
        return;
    }

    chatSocket.onopen = function() {
        appendChatMessage('Connection successful! You can start chatting.', 'admin');
        document.getElementById('chat-message-input').disabled = false;
        document.getElementById('chat-send-btn').disabled = false;
        document.getElementById('chat-message-input').focus();
    };

    chatSocket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const sender = (data.sender === 'admin') ? 'admin' : 'customer'; 
        appendChatMessage(data.message, sender);
    };

    chatSocket.onclose = function() {
        appendChatMessage('Connection closed. Refresh list to re-initiate chat.', 'admin');
        document.getElementById('chat-message-input').disabled = true;
        document.getElementById('chat-send-btn').disabled = true;
        chatSocket = null;
    };

    chatSocket.onerror = function(error) {
        console.error('WebSocket Error:', error);
        appendChatMessage('Connection error occurred. Check server logs.', 'admin');
    };
}

/**
 * Sends a message from the admin to the customer via WebSocket.
 */
function sendChatMessage() {
    const input = document.getElementById('chat-message-input');
    const message = input.value.trim();

    if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        const payload = {
            sender: 'admin', 
            message: message,
        };
        chatSocket.send(JSON.stringify(payload));
        
        appendChatMessage(message, 'admin'); 
        input.value = ''; 
        input.focus();
    } else if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
        showToast('Chat is not connected. Please reopen the chat modal.', 'error');
    }
}

/**
 * Fetches historical chat messages for the current customer ID.
 */
async function fetchChatHistory(customerId) {
    const chatBody = document.getElementById('chat-messages');
    try {
        // Use the Admin API route for history
        const response = await fetch(`${API_BASE_URL}/admin/chat/history/${customerId}`);
        
        if (!response.ok) {
            appendChatMessage('Could not load chat history. Starting fresh conversation.', 'admin');
            return;
        }

        const history = await response.json();
        chatBody.innerHTML = ''; 
        
        if (history.length === 0) {
            appendChatMessage('No prior chat history found. Start the conversation!', 'admin');
            return;
        }

        history.forEach(msg => {
            // Note: History messages are already stored as 'admin' or 'customer' sender_role
            const sender = (msg.sender === 'admin') ? 'admin' : 'customer';
            appendChatMessage(msg.message_content, sender);
        });
        chatBody.scrollTop = chatBody.scrollHeight;

    } catch (error) {
        console.error('Error fetching chat history:', error);
        appendChatMessage('Error loading chat history due to a network error.', 'admin');
    }
}

   </script>
    
</body>
</html>
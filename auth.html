<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Access | Lolly's Collection</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/x-icon" href="images/icons/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { 
            --color-pink-dark: #C2185B;
            --color-pink-accent: #E91E63;
            --color-text-dark: #333333;
            --font-body: 'Poppins', sans-serif;
            --font-heading: 'Playfair Display', serif;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-text-subtle: #757575;
            --color-bg-light: #FFFFFF;
            --color-info: #17a2b8;
        }
        
        body {
            font-family: var(--font-body);
            background-color: #fce4ec;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow-y: auto;
        }
        .container { width: 100%; max-width: 400px; padding: 20px; }
        .auth-card {
            background: var(--color-bg-light);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            padding: 40px 30px;
            text-align: center;
        }
        h2, h3 { font-family: var(--font-heading); color: var(--color-pink-dark); margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-text-dark); }
        .form-group input {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
            box-sizing: border-box; font-size: 16px; transition: border-color 0.3s;
        }
        .form-group input:focus { border-color: var(--color-pink-accent); outline: none; }
        .btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px;
            cursor: pointer; transition: background-color 0.3s, transform 0.1s; font-weight: 600;
        }
        .btn-primary { background-color: var(--color-pink-accent); color: white; margin-top: 10px; }
        .btn-primary:hover { background-color: var(--color-pink-dark); transform: translateY(-1px); }
        .toggle-link { display: block; margin-top: 15px; color: var(--color-pink-accent); text-decoration: none; font-size: 14px; }
        .forgot-password { float: right; font-size: 14px; color: var(--color-text-subtle); text-decoration: none; margin-top: 5px; }
        
        /* Modal and Step Visibility */
        .modal {
            display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; backdrop-filter: blur(3px);
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 380px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s ease-out;
        }
        .step-hidden { display: none; }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Toast Notifications */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 20px; border-radius: 8px; color: white; min-width: 250px; transition: 0.5s; opacity: 0; transform: translateX(100%); }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-success { background: var(--color-success); }
        .toast-error { background: var(--color-danger); }
        .toast-info { background: var(--color-info); }
    </style>
</head>
<body>

    <div class="container">
        <div class="auth-card">
            <h2 id="form-title">Login to Account</h2>
            
            <form id="login-form">
                <div class="form-group">
                    <label>National ID</label>
                    <input type="text" id="login-id" placeholder="Enter National ID" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" placeholder="Enter Password" required>
                    <a href="#" id="forgot-pw-link" class="forgot-password">Forgot Password?</a>
                </div>
                <button type="submit" class="btn btn-primary" id="login-btn">Login</button>
            </form>

            <form id="register-form" style="display:none;">
                <div class="form-group"><label>National ID</label><input type="text" id="reg-id" required></div>
                <div class="form-group"><label>Username</label><input type="text" id="reg-username" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="reg-email" required></div>
                <div class="form-group"><label>Password</label><input type="password" id="reg-password" required></div>
                <div class="form-group"><label>Confirm Password</label><input type="password" id="reg-confirm" required></div>
                <button type="submit" class="btn btn-primary">Register</button>
            </form>

            <a href="#" class="toggle-link" id="toggle-auth">Need an account? Register</a>
        </div>
    </div>

    <div id="totp-modal" class="modal">
        <div class="modal-content">
            <h3>2FA Verification</h3>
            <p>Enter the code from your authenticator app.</p>
            <form id="totp-form">
                <div class="form-group"><input type="text" id="totp-code" maxlength="6" placeholder="000000" required></div>
                <button type="submit" class="btn btn-primary">Verify & Login</button>
            </form>
        </div>
    </div>

    <div id="forgot-modal" class="modal">
        <div class="modal-content">
            <h3>Reset Password</h3>
            
            <div id="step-request">
                <p>Enter your registered email.</p>
                <div class="form-group"><input type="email" id="reset-email-input" placeholder="user@example.com" required></div>
                <button type="button" class="btn btn-primary" id="send-otp-btn">Send Code</button>
            </div>

            <div id="step-verify" class="step-hidden">
                <p>Enter the 6-digit code sent to your email.</p>
                <div class="form-group"><input type="text" id="reset-otp-input" maxlength="6" placeholder="000000"></div>
                <button type="button" class="btn btn-primary" id="verify-otp-btn">Verify Code</button>
            </div>

            <div id="step-new-pw" class="step-hidden">
                <p>Set your new password.</p>
                <div class="form-group"><input type="password" id="new-pw" placeholder="New Password"></div>
                <div class="form-group"><input type="password" id="confirm-new-pw" placeholder="Confirm Password"></div>
                <button type="button" class="btn btn-primary" id="finish-reset-btn">Update Password</button>
            </div>
            <button type="button" onclick="closeModals()" class="toggle-link" style="border:none; background:none; cursor:pointer; width:100%;">Cancel</button>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        const API = {
            login: '/api/login',
            verify2fa: '/api/2fa/verify-login',
            register: '/api/register',
            requestOtp: '/api/request-otp',
            verifyOtp: '/api/verify-otp',
            updatePw: '/api/update-password' 
        };

        let pendingCreds = {};
        let resetEmail = '';
        let vToken = '';

        function showToast(msg, type='info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = msg;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); setTimeout(()=>toast.remove(), 500); }, 4000);
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            document.getElementById('step-request').classList.remove('step-hidden');
            document.getElementById('step-verify').classList.add('step-hidden');
            document.getElementById('step-new-pw').classList.add('step-hidden');
        }

        // Login Logic
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nationalId = document.getElementById('login-id').value;
            const password = document.getElementById('login-password').value;

            try {
                const res = await fetch(API.login, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ nationalId, password })
                });
                const data = await res.json();

                if (res.ok) {
                    if (data.is2faRequired) {
                        pendingCreds = { nationalId, password };
                        document.getElementById('totp-modal').style.display = 'flex';
                    } else {
                        window.location.href = '/profile.html';
                    }
                } else { showToast(data.message, 'error'); }
            } catch { showToast('Server error', 'error'); }
        });

        // 2FA Verification Logic
        document.getElementById('totp-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const totpCode = document.getElementById('totp-code').value;
            try {
                const res = await fetch(API.verify2fa, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ...pendingCreds, totpCode })
                });
                if (res.ok) window.location.href = '/profile.html';
                else showToast('Invalid code', 'error');
            } catch { showToast('Verification failed', 'error'); }
        });

        // Forgot Password Workflow
        document.getElementById('forgot-pw-link').onclick = () => document.getElementById('forgot-modal').style.display = 'flex';

        document.getElementById('send-otp-btn').onclick = async () => {
            resetEmail = document.getElementById('reset-email-input').value;
            const res = await fetch(API.requestOtp, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: resetEmail })
            });
            if (res.ok) {
                document.getElementById('step-request').classList.add('step-hidden');
                document.getElementById('step-verify').classList.remove('step-hidden');
                showToast('Code sent!', 'success');
            } else showToast('User not found', 'error');
        };

        document.getElementById('verify-otp-btn').onclick = async () => {
            const otp = document.getElementById('reset-otp-input').value;
            const res = await fetch(API.verifyOtp, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: resetEmail, otp })
            });
            const data = await res.json();
            if (res.ok) {
                vToken = data.verificationToken;
                document.getElementById('step-verify').classList.add('step-hidden');
                document.getElementById('step-new-pw').classList.remove('step-hidden');
            } else showToast('Invalid OTP', 'error');
        };

        document.getElementById('finish-reset-btn').onclick = async () => {
            const password = document.getElementById('new-pw').value;
            if (password !== document.getElementById('confirm-new-pw').value) return showToast('Mismatch', 'error');
            
            const res = await fetch(API.updatePw, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: resetEmail, password, vtoken: vToken })
            });
            if (res.ok) { showToast('Updated!', 'success'); closeModals(); }
            else showToast('Update failed', 'error');
        };

        // UI Toggle
        document.getElementById('toggle-auth').onclick = () => {
            const isLogin = document.getElementById('login-form').style.display !== 'none';
            document.getElementById('login-form').style.display = isLogin ? 'none' : 'block';
            document.getElementById('register-form').style.display = isLogin ? 'block' : 'none';
            document.getElementById('form-title').textContent = isLogin ? 'Register' : 'Login';
        };
    </script>
</body>
</html>